"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginShortcutKey = exports.handleFuncs = exports.SKey = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var _handleFuncs;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var arrowKeys = 'right,up,left,down'.split(',');
var specialKeys = 'alt,ctrl,shift,meta'.split(',');
var settingMaps = {};
var listenerMaps = {};
var disabledMaps = {};

var SKey = /*#__PURE__*/function () {
  function SKey(realKey, specialKey, funcName, kConf) {
    _classCallCheck(this, SKey);

    this.realKey = realKey;
    this.specialKey = specialKey;
    this.funcName = funcName;
    this.kConf = kConf;
  }

  _createClass(SKey, [{
    key: "trigger"
    /* TRIGGER */
    ,
    value: function trigger(params, evnt) {
      if (!this.specialKey || evnt["".concat(this.specialKey, "Key")]) {
        if (this.funcName) {
          return handleFuncs[this.funcName](params, evnt);
        }
      }
    }
  }, {
    key: "emit"
    /* EMIT */
    ,
    value: function emit(params, evnt) {
      if (!this.specialKey || evnt["".concat(this.specialKey, "Key")]) {
        if (this.kConf) {
          return this.kConf.callback(params, evnt);
        }
      }
    }
  }]);

  return SKey;
}();

exports.SKey = SKey;

function getEventKey(key) {
  if (arrowKeys.indexOf(key.toLowerCase()) > -1) {
    return "Arrow".concat(key);
  }

  return key;
}

function isTriggerPage(params) {
  return !params.$table.getActiveRecord();
}

function handleChangePage(func) {
  return function (params, evnt) {
    var $grid = params.$grid,
        $table = params.$table;
    var _$table$mouseConfig = $table.mouseConfig,
        mouseConfig = _$table$mouseConfig === void 0 ? {} : _$table$mouseConfig;

    if ($grid && mouseConfig.selected !== true && ['input', 'textarea'].indexOf(evnt.target.tagName.toLowerCase()) === -1 && isTriggerPage(params)) {
      var pager = $grid.$refs.pager;

      if (pager) {
        evnt.preventDefault();
        pager[func](evnt);
      }
    }
  };
}

function handleCellTabMove(isLeft) {
  return function (params, evnt) {
    var $table = params.$table;
    var activeParams = $table.getActiveRecord();
    var selecteParams = $table.getSelectedCell();

    if (selecteParams || activeParams) {
      $table.moveTabSelected(selecteParams || activeParams, isLeft, evnt);
    }

    return false;
  };
}

function handleCellMove(arrowIndex) {
  return function (params, evnt) {
    var $table = params.$table;
    var selecteParams = $table.getSelectedCell();
    var arrows = [0, 0, 0, 0];
    arrows[arrowIndex] = 1;

    if (selecteParams) {
      $table.moveSelected(selecteParams, arrows[0], arrows[1], arrows[2], arrows[3], evnt);
      return false;
    }
  };
}

function handleCurrentRowMove(isDown) {
  return function (params, evnt) {
    var $table = params.$table;

    if ($table.highlightCurrentRow) {
      var currentRow = $table.getCurrentRecord();

      if (currentRow) {
        $table.moveCurrentRow(!isDown, isDown, evnt);
        return false;
      }
    }
  };
}
/**
 * 快捷键处理方法
 */


var handleFuncs = (_handleFuncs = {}, _defineProperty(_handleFuncs, "table.edit.actived"
/* TABLE_EDIT_ACTIVED */
, function tableEditActived(params, evnt) {
  var $table = params.$table;
  var selected = $table.getSelectedCell();

  if (selected) {
    evnt.preventDefault();
    $table.setActiveCell(selected.row, selected.column.property);
    return false;
  }
}), _defineProperty(_handleFuncs, "table.edit.closed"
/* TABLE_EDIT_CLOSED */
, function tableEditClosed(params, evnt) {
  var $table = params.$table;
  var _$table$mouseConfig2 = $table.mouseConfig,
      mouseConfig = _$table$mouseConfig2 === void 0 ? {} : _$table$mouseConfig2;
  var actived = $table.getActiveRecord();

  if (actived) {
    evnt.preventDefault();
    $table.clearActived();

    if (mouseConfig.selected) {
      $table.$nextTick(function () {
        return $table.setSelectCell(actived.row, actived.column.property);
      });
    }

    return false;
  }
}), _defineProperty(_handleFuncs, "table.edit.rightTabMove"
/* TABLE_EDIT_RIGHTTABMOVE */
, handleCellTabMove(false)), _defineProperty(_handleFuncs, "table.edit.leftTabMove"
/* TABLE_EDIT_LEFTTABMOVE */
, handleCellTabMove(true)), _defineProperty(_handleFuncs, "table.cell.leftMove"
/* TABLE_CELL_LEFTMOVE */
, handleCellMove(0)), _defineProperty(_handleFuncs, "table.cell.upMove"
/* TABLE_CELL_UPMOVE */
, handleCellMove(1)), _defineProperty(_handleFuncs, "table.cell.rightMove"
/* TABLE_CELL_RIGHTMOVE */
, handleCellMove(2)), _defineProperty(_handleFuncs, "table.cell.downMove"
/* TABLE_CELL_DOWNMOVE */
, handleCellMove(3)), _defineProperty(_handleFuncs, "table.row.current.topMove"
/* TABLE_ROW_CURRENT_TOPMOVE */
, handleCurrentRowMove(false)), _defineProperty(_handleFuncs, "table.row.current.downMove"
/* TABLE_ROW_CURRENT_DOWNMOVE */
, handleCurrentRowMove(true)), _defineProperty(_handleFuncs, "pager.prevPage"
/* PAGER_PREVPAGE */
, handleChangePage('prevPage')), _defineProperty(_handleFuncs, "pager.nextPage"
/* PAGER_NEXTPAGE */
, handleChangePage('nextPage')), _defineProperty(_handleFuncs, "pager.prevJump"
/* PAGER_PREVJUMP */
, handleChangePage('prevJump')), _defineProperty(_handleFuncs, "pager.nextJump"
/* PAGER_NEXTJUMP */
, handleChangePage('nextJump')), _handleFuncs);
exports.handleFuncs = handleFuncs;

function runEvent(key, maps, prop, params, evnt) {
  var skeyList = maps[key.toLowerCase()];

  if (skeyList) {
    return !skeyList.some(function (skey) {
      return skey[prop](params, evnt) === false;
    });
  }
}

function handleShortcutKeyEvent(params, evnt) {
  var key = getEventKey(evnt.key);

  if (!runEvent(key, disabledMaps, "emit"
  /* EMIT */
  , params, evnt)) {
    if (runEvent(key, settingMaps, "trigger"
    /* TRIGGER */
    , params, evnt) === false) {
      return false;
    }

    runEvent(key, listenerMaps, "emit"
    /* EMIT */
    , params, evnt);
  }
}

function parseKeys(key) {
  var specialKey = '';
  var realKey = '';
  var keys = key.split('+');
  keys.forEach(function (item) {
    item = item.toLowerCase().trim();

    if (specialKeys.indexOf(item) > -1) {
      specialKey = item;
    } else {
      realKey = item;
    }
  });

  if (!realKey || keys.length > 2 || keys.length === 2 && !specialKey) {
    throw new Error("[vxe-table-plugin-shortcut-key] Invalid shortcut key configuration '".concat(key, "'."));
  }

  return {
    realKey: realKey,
    specialKey: specialKey
  };
}

function setKeyQueue(maps, kConf, funcName) {
  var _parseKeys = parseKeys(kConf.key),
      realKey = _parseKeys.realKey,
      specialKey = _parseKeys.specialKey;

  var skeyList = maps[realKey];

  if (!skeyList) {
    skeyList = maps[realKey] = [];
  }

  if (skeyList.some(function (skey) {
    return skey.realKey === realKey && skey.specialKey === specialKey;
  })) {
    throw new Error("[vxe-table-plugin-shortcut-key] Shortcut key conflict '".concat(kConf.key, "'."));
  }

  skeyList.push(new SKey(realKey, specialKey, funcName, kConf));
}

function parseDisabledKey(options) {
  _xeUtils["default"].each(options.disabled, function (conf) {
    var opts = _xeUtils["default"].isString(conf) ? {
      key: conf
    } : conf;
    setKeyQueue(disabledMaps, _xeUtils["default"].assign({
      callback: function callback() {
        return false;
      }
    }, opts));
  });
}

function parseSettingKey(options) {
  _xeUtils["default"].each(options.setting, function (opts, funcName) {
    var kConf = _xeUtils["default"].isString(opts) ? {
      key: opts
    } : opts;

    if (!handleFuncs[funcName]) {
      console.warn("[vxe-table-plugin-shortcut-key] '".concat(funcName, "' not exist."));
    }

    setKeyQueue(settingMaps, kConf, funcName);
  });
}

function parseListenerKey(options) {
  _xeUtils["default"].each(options.listener, function (callback, key) {
    if (!_xeUtils["default"].isFunction(callback)) {
      console.warn("[vxe-table-plugin-shortcut-key] '".concat(key, "' requires the callback function to be set."));
    }

    setKeyQueue(listenerMaps, {
      key: key,
      callback: callback
    });
  });
}
/**
 * 设置参数
 * @param options 参数
 */


function setup(options) {
  if (options) {
    parseDisabledKey(options);
    parseSettingKey(options);
    parseListenerKey(options);
  }
}
/**
 * 基于 vxe-table 表格的增强插件，为键盘操作提供快捷键的设置
 */


var VXETablePluginShortcutKey = {
  setup: setup,
  install: function install(xtable, options) {
    if (options) {
      setup(options);
    }

    xtable.interceptor.add('event.keydown', handleShortcutKeyEvent);
  }
};
exports.VXETablePluginShortcutKey = VXETablePluginShortcutKey;

if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginShortcutKey);
}

var _default = VXETablePluginShortcutKey;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImFycm93S2V5cyIsInNwbGl0Iiwic3BlY2lhbEtleXMiLCJzZXR0aW5nTWFwcyIsImxpc3RlbmVyTWFwcyIsImRpc2FibGVkTWFwcyIsIlNLZXkiLCJyZWFsS2V5Iiwic3BlY2lhbEtleSIsImZ1bmNOYW1lIiwia0NvbmYiLCJwYXJhbXMiLCJldm50IiwiaGFuZGxlRnVuY3MiLCJjYWxsYmFjayIsImdldEV2ZW50S2V5Iiwia2V5IiwiaW5kZXhPZiIsInRvTG93ZXJDYXNlIiwiaXNUcmlnZ2VyUGFnZSIsIiR0YWJsZSIsImdldEFjdGl2ZVJlY29yZCIsImhhbmRsZUNoYW5nZVBhZ2UiLCJmdW5jIiwiJGdyaWQiLCJtb3VzZUNvbmZpZyIsInNlbGVjdGVkIiwidGFyZ2V0IiwidGFnTmFtZSIsInBhZ2VyIiwiJHJlZnMiLCJwcmV2ZW50RGVmYXVsdCIsImhhbmRsZUNlbGxUYWJNb3ZlIiwiaXNMZWZ0IiwiYWN0aXZlUGFyYW1zIiwic2VsZWN0ZVBhcmFtcyIsImdldFNlbGVjdGVkQ2VsbCIsIm1vdmVUYWJTZWxlY3RlZCIsImhhbmRsZUNlbGxNb3ZlIiwiYXJyb3dJbmRleCIsImFycm93cyIsIm1vdmVTZWxlY3RlZCIsImhhbmRsZUN1cnJlbnRSb3dNb3ZlIiwiaXNEb3duIiwiaGlnaGxpZ2h0Q3VycmVudFJvdyIsImN1cnJlbnRSb3ciLCJnZXRDdXJyZW50UmVjb3JkIiwibW92ZUN1cnJlbnRSb3ciLCJzZXRBY3RpdmVDZWxsIiwicm93IiwiY29sdW1uIiwicHJvcGVydHkiLCJhY3RpdmVkIiwiY2xlYXJBY3RpdmVkIiwiJG5leHRUaWNrIiwic2V0U2VsZWN0Q2VsbCIsInJ1bkV2ZW50IiwibWFwcyIsInByb3AiLCJza2V5TGlzdCIsInNvbWUiLCJza2V5IiwiaGFuZGxlU2hvcnRjdXRLZXlFdmVudCIsInBhcnNlS2V5cyIsImtleXMiLCJmb3JFYWNoIiwiaXRlbSIsInRyaW0iLCJsZW5ndGgiLCJFcnJvciIsInNldEtleVF1ZXVlIiwicHVzaCIsInBhcnNlRGlzYWJsZWRLZXkiLCJvcHRpb25zIiwiWEVVdGlscyIsImVhY2giLCJkaXNhYmxlZCIsImNvbmYiLCJvcHRzIiwiaXNTdHJpbmciLCJhc3NpZ24iLCJwYXJzZVNldHRpbmdLZXkiLCJzZXR0aW5nIiwiY29uc29sZSIsIndhcm4iLCJwYXJzZUxpc3RlbmVyS2V5IiwibGlzdGVuZXIiLCJpc0Z1bmN0aW9uIiwic2V0dXAiLCJWWEVUYWJsZVBsdWdpblNob3J0Y3V0S2V5IiwiaW5zdGFsbCIsInh0YWJsZSIsImludGVyY2VwdG9yIiwiYWRkIiwid2luZG93IiwiVlhFVGFibGUiLCJ1c2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7QUE4QkEsSUFBTUEsU0FBUyxHQUFHLHFCQUFxQkMsS0FBckIsQ0FBMkIsR0FBM0IsQ0FBbEI7QUFDQSxJQUFNQyxXQUFXLEdBQUcsc0JBQXNCRCxLQUF0QixDQUE0QixHQUE1QixDQUFwQjtBQUNBLElBQU1FLFdBQVcsR0FBaUIsRUFBbEM7QUFDQSxJQUFNQyxZQUFZLEdBQWlCLEVBQW5DO0FBQ0EsSUFBTUMsWUFBWSxHQUFpQixFQUFuQzs7SUFFYUMsSTtBQUtYLGdCQUFhQyxPQUFiLEVBQThCQyxVQUE5QixFQUFrREMsUUFBbEQsRUFBd0VDLEtBQXhFLEVBQStGO0FBQUE7O0FBQzdGLFNBQUtILE9BQUwsR0FBZUEsT0FBZjtBQUNBLFNBQUtDLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQkEsUUFBaEI7QUFDQSxTQUFLQyxLQUFMLEdBQWFBLEtBQWI7QUFDRDs7O1NBQ0Q7QUFBQTs7NEJBQXFCQyxNLEVBQWtDQyxJLEVBQVM7QUFDOUQsVUFBSSxDQUFDLEtBQUtKLFVBQU4sSUFBb0JJLElBQUksV0FBSSxLQUFLSixVQUFULFNBQTVCLEVBQXVEO0FBQ3JELFlBQUksS0FBS0MsUUFBVCxFQUFtQjtBQUNqQixpQkFBT0ksV0FBVyxDQUFDLEtBQUtKLFFBQU4sQ0FBWCxDQUEyQkUsTUFB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LEVBQWE7QUFDWGUsTUFBQUEsS0FBSyxDQUFDZixPQUFELENBQUw7QUFDRDs7QUFDRGtCLElBQUFBLE1BQU0sQ0FBQ0MsV0FBUCxDQUFtQkMsR0FBbkIsQ0FBdUIsZUFBdkIsRUFBd0MvQixzQkFBeEM7QUFDRDtBQVBzQyxDQUFsQzs7O0FBVVAsSUFBSSxPQUFPZ0MsTUFBUCxLQUFrQixXQUFsQixJQUFpQ0EsTUFBTSxDQUFDQyxRQUE1QyxFQUFzRDtBQUNwREQsRUFBQUEsTUFBTSxDQUFDQyxRQUFQLENBQWdCQyxHQUFoQixDQUFvQlAseUJBQXBCO0FBQ0Q7O2VBRWNBLHlCIiwiZmlsZSI6ImluZGV4LmNvbW1vbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLXVudXNlZC12YXJzICovXHJcbmltcG9ydCBYRVV0aWxzIGZyb20gJ3hlLXV0aWxzL21ldGhvZHMveGUtdXRpbHMnXHJcbmltcG9ydCB7IFZYRVRhYmxlLCBJbnRlcmNlcHRvcktleWRvd25QYXJhbXMgfSBmcm9tICd2eGUtdGFibGUvbGliL3Z4ZS10YWJsZSdcclxuXHJcbmV4cG9ydCBjb25zdCBlbnVtIEZVTkNfTkFORSB7XHJcbiAgVEFCTEVfRURJVF9BQ1RJVkVEID0gJ3RhYmxlLmVkaXQuYWN0aXZlZCcsXHJcbiAgVEFCTEVfRURJVF9DTE9TRUQgPSAndGFibGUuZWRpdC5jbG9zZWQnLFxyXG4gIFRBQkxFX0VESVRfUklHSFRUQUJNT1ZFID0gJ3RhYmxlLmVkaXQucmlnaHRUYWJNb3ZlJyxcclxuICBUQUJMRV9FRElUX0xFRlRUQUJNT1ZFID0gJ3RhYmxlLmVkaXQubGVmdFRhYk1vdmUnLFxyXG4gIFRBQkxFX0NFTExfTEVGVE1PVkUgPSAndGFibGUuY2VsbC5sZWZ0TW92ZScsXHJcbiAgVEFCTEVfQ0VMTF9VUE1PVkUgPSAndGFibGUuY2VsbC51cE1vdmUnLFxyXG4gIFRBQkxFX0NFTExfUklHSFRNT1ZFID0gJ3RhYmxlLmNlbGwucmlnaHRNb3ZlJyxcclxuICBUQUJMRV9DRUxMX0RPV05NT1ZFID0gJ3RhYmxlLmNlbGwuZG93bk1vdmUnLFxyXG4gIFRBQkxFX1JPV19DVVJSRU5UX1RPUE1PVkUgPSAndGFibGUucm93LmN1cnJlbnQudG9wTW92ZScsXHJcbiAgVEFCTEVfUk9XX0NVUlJFTlRfRE9XTk1PVkUgPSAndGFibGUucm93LmN1cnJlbnQuZG93bk1vdmUnLFxyXG4gIFBBR0VSX1BSRVZQQUdFID0gJ3BhZ2VyLnByZXZQYWdlJyxcclxuICBQQUdFUl9ORVhUUEFHRSA9ICdwYWdlci5uZXh0UGFnZScsXHJcbiAgUEFHRVJfUFJFVkpVTVAgPSAncGFnZXIucHJldkp1bXAnLFxyXG4gIFBBR0VSX05FWFRKVU1QID0gJ3BhZ2VyLm5leHRKdW1wJ1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgZW51bSBTS0VZX05BTkUge1xyXG4gIFRSSUdHRVIgPSAndHJpZ2dlcicsXHJcbiAgRU1JVCA9ICdlbWl0J1xyXG59XHJcbi8qIGVzbGludC1lbmFibGUgbm8tdW51c2VkLXZhcnMgKi9cclxuXHJcbmludGVyZmFjZSBLZXlTdG9yZU1hcHMge1xyXG4gIFtwcm9wTmFtZTogc3RyaW5nXTogU0tleVtdO1xyXG59XHJcblxyXG5jb25zdCBhcnJvd0tleXMgPSAncmlnaHQsdXAsbGVmdCxkb3duJy5zcGxpdCgnLCcpXHJcbmNvbnN0IHNwZWNpYWxLZXlzID0gJ2FsdCxjdHJsLHNoaWZ0LG1ldGEnLnNwbGl0KCcsJylcclxuY29uc3Qgc2V0dGluZ01hcHM6IEtleVN0b3JlTWFwcyA9IHt9XHJcbmNvbnN0IGxpc3RlbmVyTWFwczogS2V5U3RvcmVNYXBzID0ge31cclxuY29uc3QgZGlzYWJsZWRNYXBzOiBLZXlTdG9yZU1hcHMgPSB7fVxyXG5cclxuZXhwb3J0IGNsYXNzIFNLZXkge1xyXG4gIHJlYWxLZXk6IHN0cmluZztcclxuICBzcGVjaWFsS2V5OiBzdHJpbmc7XHJcbiAgZnVuY05hbWU/OiBGVU5DX05BTkU7XHJcbiAga0NvbmY/OiBTaG9ydGN1dEtleUNvbmY7XHJcbiAgY29uc3RydWN0b3IgKHJlYWxLZXk6IHN0cmluZywgc3BlY2lhbEtleTogc3RyaW5nLCBmdW5jTmFtZT86IEZVTkNfTkFORSwga0NvbmY/OiBTaG9ydGN1dEtleUNvbmYpIHtcclxuICAgIHRoaXMucmVhbEtleSA9IHJlYWxLZXlcclxuICAgIHRoaXMuc3BlY2lhbEtleSA9IHNwZWNpYWxLZXlcclxuICAgIHRoaXMuZnVuY05hbWUgPSBmdW5jTmFtZVxyXG4gICAgdGhpcy5rQ29uZiA9IGtDb25mXHJcbiAgfVxyXG4gIFtTS0VZX05BTkUuVFJJR0dFUl0gKHBhcmFtczogSW50ZXJjZXB0b3JLZXlkb3duUGFyYW1zLCBldm50OiBhbnkpIHtcclxuICAgIGlmICghdGhpcy5zcGVjaWFsS2V5IHx8IGV2bnRbYCR7dGhpcy5zcGVjaWFsS2V5fUtleWBdKSB7XHJcbiAgICAgIGlmICh0aGlzLmZ1bmNOYW1lKSB7XHJcbiAgICAgICAgcmV0dXJuIGhhbmRsZUZ1bmNzW3RoaXMuZnVuY05hbWVdKHBhcmFtcywgZXZudClcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICBbU0tFWV9OQU5FLkVNSVRdIChwYXJhbXM6IEludGVyY2VwdG9yS2V5ZG93blBhcmFtcywgZXZudDogYW55KSB7XHJcbiAgICBpZiAoIXRoaXMuc3BlY2lhbEtleSB8fCBldm50W2Ake3RoaXMuc3BlY2lhbEtleX1LZXlgXSkge1xyXG4gICAgICBpZiAodGhpcy5rQ29uZikge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmtDb25mLmNhbGxiYWNrKHBhcmFtcywgZXZudClcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0RXZlbnRLZXkgKGtleTogc3RyaW5nKTogc3RyaW5nIHtcclxuICBpZiAoYXJyb3dLZXlzLmluZGV4T2Yoa2V5LnRvTG93ZXJDYXNlKCkpID4gLTEpIHtcclxuICAgIHJldHVybiBgQXJyb3cke2tleX1gXHJcbiAgfVxyXG4gIHJldHVybiBrZXlcclxufVxyXG5cclxuZnVuY3Rpb24gaXNUcmlnZ2VyUGFnZSAocGFyYW1zOiBJbnRlcmNlcHRvcktleWRvd25QYXJhbXMpOiBib29sZWFuIHtcclxuICByZXR1cm4gIXBhcmFtcy4kdGFibGUuZ2V0QWN0aXZlUmVjb3JkKClcclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlQ2hhbmdlUGFnZSAoZnVuYzogc3RyaW5nKSB7XHJcbiAgcmV0dXJuIGZ1bmN0aW9uIChwYXJhbXM6IEludGVyY2VwdG9yS2V5ZG93blBhcmFtcywgZXZudDogYW55KSB7XHJcbiAgICBjb25zdCB7ICRncmlkLCAkdGFibGUgfSA9IHBhcmFtc1xyXG4gICAgY29uc3QgeyBtb3VzZUNvbmZpZyA9IHt9IH0gPSAkdGFibGVcclxuICAgIGlmICgkZ3JpZCAmJiBtb3VzZUNvbmZpZy5zZWxlY3RlZCAhPT0gdHJ1ZSAmJiBbJ2lucHV0JywgJ3RleHRhcmVhJ10uaW5kZXhPZihldm50LnRhcmdldC50YWdOYW1lLnRvTG93ZXJDYXNlKCkpID09PSAtMSAmJiBpc1RyaWdnZXJQYWdlKHBhcmFtcykpIHtcclxuICAgICAgY29uc3QgcGFnZXI6IGFueSA9ICRncmlkLiRyZWZzLnBhZ2VyXHJcbiAgICAgIGlmIChwYWdlcikge1xyXG4gICAgICAgIGV2bnQucHJldmVudERlZmF1bHQoKVxyXG4gICAgICAgIHBhZ2VyW2Z1bmNdKGV2bnQpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUNlbGxUYWJNb3ZlIChpc0xlZnQ6IGJvb2xlYW4pIHtcclxuICByZXR1cm4gZnVuY3Rpb24gKHBhcmFtczogYW55LCBldm50OiBhbnkpOiBhbnkge1xyXG4gICAgY29uc3QgeyAkdGFibGUgfSA9IHBhcmFtc1xyXG4gICAgY29uc3QgYWN0aXZlUGFyYW1zID0gJHRhYmxlLmdldEFjdGl2ZVJlY29yZCgpXHJcbiAgICBjb25zdCBzZWxlY3RlUGFyYW1zID0gJHRhYmxlLmdldFNlbGVjdGVkQ2VsbCgpXHJcbiAgICBpZiAoc2VsZWN0ZVBhcmFtcyB8fCBhY3RpdmVQYXJhbXMpIHtcclxuICAgICAgJHRhYmxlLm1vdmVUYWJTZWxlY3RlZChzZWxlY3RlUGFyYW1zIHx8IGFjdGl2ZVBhcmFtcywgaXNMZWZ0LCBldm50KVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVDZWxsTW92ZSAoYXJyb3dJbmRleDogbnVtYmVyKSB7XHJcbiAgcmV0dXJuIGZ1bmN0aW9uIChwYXJhbXM6IEludGVyY2VwdG9yS2V5ZG93blBhcmFtcywgZXZudDogYW55KSB7XHJcbiAgICBjb25zdCAkdGFibGU6IGFueSA9IHBhcmFtcy4kdGFibGVcclxuICAgIGNvbnN0IHNlbGVjdGVQYXJhbXMgPSAkdGFibGUuZ2V0U2VsZWN0ZWRDZWxsKClcclxuICAgIGNvbnN0IGFycm93czogbnVtYmVyW10gPSBbMCwgMCwgMCwgMF1cclxuICAgIGFycm93c1thcnJvd0luZGV4XSA9IDFcclxuICAgIGlmIChzZWxlY3RlUGFyYW1zKSB7XHJcbiAgICAgICR0YWJsZS5tb3ZlU2VsZWN0ZWQoc2VsZWN0ZVBhcmFtcywgYXJyb3dzWzBdLCBhcnJvd3NbMV0sIGFycm93c1syXSwgYXJyb3dzWzNdLCBldm50KVxyXG4gICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUN1cnJlbnRSb3dNb3ZlIChpc0Rvd246IGJvb2xlYW4pIHtcclxuICByZXR1cm4gZnVuY3Rpb24gKHBhcmFtczogSW50ZXJjZXB0b3JLZXlkb3duUGFyYW1zLCBldm50OiBhbnkpIHtcclxuICAgIGNvbnN0ICR0YWJsZTogYW55ID0gcGFyYW1zLiR0YWJsZVxyXG4gICAgaWYgKCR0YWJsZS5oaWdobGlnaHRDdXJyZW50Um93KSB7XHJcbiAgICAgIGNvbnN0IGN1cnJlbnRSb3cgPSAkdGFibGUuZ2V0Q3VycmVudFJlY29yZCgpXHJcbiAgICAgIGlmIChjdXJyZW50Um93KSB7XHJcbiAgICAgICAgJHRhYmxlLm1vdmVDdXJyZW50Um93KCFpc0Rvd24sIGlzRG93biwgZXZudClcclxuICAgICAgICByZXR1cm4gZmFsc2VcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOW/q+aNt+mUruWkhOeQhuaWueazlVxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IGhhbmRsZUZ1bmNzID0ge1xyXG4gIFtGVU5DX05BTkUuVEFCTEVfRURJVF9BQ1RJVkVEXSAocGFyYW1zOiBJbnRlcmNlcHRvcktleWRvd25QYXJhbXMsIGV2bnQ6IGFueSkge1xyXG4gICAgY29uc3QgeyAkdGFibGUgfSA9IHBhcmFtc1xyXG4gICAgY29uc3Qgc2VsZWN0ZWQgPSAkdGFibGUuZ2V0U2VsZWN0ZWRDZWxsKClcclxuICAgIGlmIChzZWxlY3RlZCkge1xyXG4gICAgICBldm50LnByZXZlbnREZWZhdWx0KClcclxuICAgICAgJHRhYmxlLnNldEFjdGl2ZUNlbGwoc2VsZWN0ZWQucm93LCBzZWxlY3RlZC5jb2x1bW4ucHJvcGVydHkpXHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG4gIH0sXHJcbiAgW0ZVTkNfTkFORS5UQUJMRV9FRElUX0NMT1NFRF0gKHBhcmFtczogSW50ZXJjZXB0b3JLZXlkb3duUGFyYW1zLCBldm50OiBhbnkpIHtcclxuICAgIGNvbnN0IHsgJHRhYmxlIH0gPSBwYXJhbXNcclxuICAgIGNvbnN0IHsgbW91c2VDb25maWcgPSB7fSB9ID0gJHRhYmxlXHJcbiAgICBjb25zdCBhY3RpdmVkID0gJHRhYmxlLmdldEFjdGl2ZVJlY29yZCgpXHJcbiAgICBpZiAoYWN0aXZlZCkge1xyXG4gICAgICBldm50LnByZXZlbnREZWZhdWx0KClcclxuICAgICAgJHRhYmxlLmNsZWFyQWN0aXZlZCgpXHJcbiAgICAgIGlmIChtb3VzZUNvbmZpZy5zZWxlY3RlZCkge1xyXG4gICAgICAgICR0YWJsZS4kbmV4dFRpY2soKCkgPT4gJHRhYmxlLnNldFNlbGVjdENlbGwoYWN0aXZlZC5yb3csIGFjdGl2ZWQuY29sdW1uLnByb3BlcnR5KSlcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuICB9LFxyXG4gIFtGVU5DX05BTkUuVEFCTEVfRURJVF9SSUdIVFRBQk1PVkVdOiBoYW5kbGVDZWxsVGFiTW92ZShmYWxzZSksXHJcbiAgW0ZVTkNfTkFORS5UQUJMRV9FRElUX0xFRlRUQUJNT1ZFXTogaGFuZGxlQ2VsbFRhYk1vdmUodHJ1ZSksXHJcbiAgW0ZVTkNfTkFORS5UQUJMRV9DRUxMX0xFRlRNT1ZFXTogaGFuZGxlQ2VsbE1vdmUoMCksXHJcbiAgW0ZVTkNfTkFORS5UQUJMRV9DRUxMX1VQTU9WRV06IGhhbmRsZUNlbGxNb3ZlKDEpLFxyXG4gIFtGVU5DX05BTkUuVEFCTEVfQ0VMTF9SSUdIVE1PVkVdOiBoYW5kbGVDZWxsTW92ZSgyKSxcclxuICBbRlVOQ19OQU5FLlRBQkxFX0NFTExfRE9XTk1PVkVdOiBoYW5kbGVDZWxsTW92ZSgzKSxcclxuICBbRlVOQ19OQU5FLlRBQkxFX1JPV19DVVJSRU5UX1RPUE1PVkVdOiBoYW5kbGVDdXJyZW50Um93TW92ZShmYWxzZSksXHJcbiAgW0ZVTkNfTkFORS5UQUJMRV9ST1dfQ1VSUkVOVF9ET1dOTU9WRV06IGhhbmRsZUN1cnJlbnRSb3dNb3ZlKHRydWUpLFxyXG4gIFtGVU5DX05BTkUuUEFHRVJfUFJFVlBBR0VdOiBoYW5kbGVDaGFuZ2VQYWdlKCdwcmV2UGFnZScpLFxyXG4gIFtGVU5DX05BTkUuUEFHRVJfTkVYVFBBR0VdOiBoYW5kbGVDaGFuZ2VQYWdlKCduZXh0UGFnZScpLFxyXG4gIFtGVU5DX05BTkUuUEFHRVJfUFJFVkpVTVBdOiBoYW5kbGVDaGFuZ2VQYWdlKCdwcmV2SnVtcCcpLFxyXG4gIFtGVU5DX05BTkUuUEFHRVJfTkVYVEpVTVBdOiBoYW5kbGVDaGFuZ2VQYWdlKCduZXh0SnVtcCcpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJ1bkV2ZW50IChrZXk6IHN0cmluZywgbWFwczogYW55LCBwcm9wOiBTS0VZX05BTkUsIHBhcmFtczogSW50ZXJjZXB0b3JLZXlkb3duUGFyYW1zLCBldm50OiBhbnkpIHtcclxuICBsZXQgc2tleUxpc3Q6IFNLZXlbXSA9IG1hcHNba2V5LnRvTG93ZXJDYXNlKCldXHJcbiAgaWYgKHNrZXlMaXN0KSB7XHJcbiAgICByZXR1cm4gIXNrZXlMaXN0LnNvbWUoKHNrZXk6IFNLZXkpID0+IHNrZXlbcHJvcF0ocGFyYW1zLCBldm50KSA9PT0gZmFsc2UpXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVTaG9ydGN1dEtleUV2ZW50IChwYXJhbXM6IEludGVyY2VwdG9yS2V5ZG93blBhcmFtcywgZXZudDogYW55KSB7XHJcbiAgbGV0IGtleTogc3RyaW5nID0gZ2V0RXZlbnRLZXkoZXZudC5rZXkpXHJcbiAgaWYgKCFydW5FdmVudChrZXksIGRpc2FibGVkTWFwcywgU0tFWV9OQU5FLkVNSVQsIHBhcmFtcywgZXZudCkpIHtcclxuICAgIGlmIChydW5FdmVudChrZXksIHNldHRpbmdNYXBzLCBTS0VZX05BTkUuVFJJR0dFUiwgcGFyYW1zLCBldm50KSA9PT0gZmFsc2UpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICB9XHJcbiAgICBydW5FdmVudChrZXksIGxpc3RlbmVyTWFwcywgU0tFWV9OQU5FLkVNSVQsIHBhcmFtcywgZXZudClcclxuICB9XHJcbn1cclxuXHJcbmludGVyZmFjZSBwYXJzZUtleVJlc3Qge1xyXG4gIHJlYWxLZXk6IHN0cmluZztcclxuICBzcGVjaWFsS2V5OiBzdHJpbmc7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlS2V5cyAoa2V5OiBzdHJpbmcpOiBwYXJzZUtleVJlc3Qge1xyXG4gIGxldCBzcGVjaWFsS2V5ID0gJydcclxuICBsZXQgcmVhbEtleSA9ICcnXHJcbiAgbGV0IGtleXMgPSBrZXkuc3BsaXQoJysnKVxyXG4gIGtleXMuZm9yRWFjaCgoaXRlbSkgPT4ge1xyXG4gICAgaXRlbSA9IGl0ZW0udG9Mb3dlckNhc2UoKS50cmltKClcclxuICAgIGlmIChzcGVjaWFsS2V5cy5pbmRleE9mKGl0ZW0pID4gLTEpIHtcclxuICAgICAgc3BlY2lhbEtleSA9IGl0ZW1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJlYWxLZXkgPSBpdGVtXHJcbiAgICB9XHJcbiAgfSlcclxuICBpZiAoIXJlYWxLZXkgfHwga2V5cy5sZW5ndGggPiAyIHx8IChrZXlzLmxlbmd0aCA9PT0gMiAmJiAhc3BlY2lhbEtleSkpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihgW3Z4ZS10YWJsZS1wbHVnaW4tc2hvcnRjdXQta2V5XSBJbnZhbGlkIHNob3J0Y3V0IGtleSBjb25maWd1cmF0aW9uICcke2tleX0nLmApXHJcbiAgfVxyXG4gIHJldHVybiB7IHJlYWxLZXksIHNwZWNpYWxLZXkgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBzZXRLZXlRdWV1ZSAobWFwczogS2V5U3RvcmVNYXBzLCBrQ29uZjogU2hvcnRjdXRLZXlDb25mLCBmdW5jTmFtZT86IEZVTkNfTkFORSkge1xyXG4gIGxldCB7IHJlYWxLZXksIHNwZWNpYWxLZXkgfSA9IHBhcnNlS2V5cyhrQ29uZi5rZXkpXHJcbiAgbGV0IHNrZXlMaXN0OiBTS2V5W10gPSBtYXBzW3JlYWxLZXldXHJcbiAgaWYgKCFza2V5TGlzdCkge1xyXG4gICAgc2tleUxpc3QgPSBtYXBzW3JlYWxLZXldID0gW11cclxuICB9XHJcbiAgaWYgKHNrZXlMaXN0LnNvbWUoKHNrZXkpID0+IHNrZXkucmVhbEtleSA9PT0gcmVhbEtleSAmJiBza2V5LnNwZWNpYWxLZXkgPT09IHNwZWNpYWxLZXkpKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFt2eGUtdGFibGUtcGx1Z2luLXNob3J0Y3V0LWtleV0gU2hvcnRjdXQga2V5IGNvbmZsaWN0ICcke2tDb25mLmtleX0nLmApXHJcbiAgfVxyXG4gIHNrZXlMaXN0LnB1c2gobmV3IFNLZXkocmVhbEtleSwgc3BlY2lhbEtleSwgZnVuY05hbWUsIGtDb25mKSlcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VEaXNhYmxlZEtleSAob3B0aW9uczogU2hvcnRjdXRLZXlPcHRpb25zKSB7XHJcbiAgWEVVdGlscy5lYWNoKG9wdGlvbnMuZGlzYWJsZWQsIChjb25mOiBzdHJpbmcgfCBTaG9ydGN1dEtleUNvbmYpID0+IHtcclxuICAgIGxldCBvcHRzOiBhbnkgPSBYRVV0aWxzLmlzU3RyaW5nKGNvbmYpID8geyBrZXk6IGNvbmYgfSA6IGNvbmZcclxuICAgIHNldEtleVF1ZXVlKGRpc2FibGVkTWFwcywgWEVVdGlscy5hc3NpZ24oeyBjYWxsYmFjazogKCkgPT4gZmFsc2UgfSwgb3B0cykpXHJcbiAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VTZXR0aW5nS2V5IChvcHRpb25zOiBTaG9ydGN1dEtleU9wdGlvbnMpIHtcclxuICBYRVV0aWxzLmVhY2gob3B0aW9ucy5zZXR0aW5nLCAob3B0czogc3RyaW5nIHwgU2hvcnRjdXRLZXlTZXR0aW5nQ29uZmlnLCBmdW5jTmFtZTogRlVOQ19OQU5FKSA9PiB7XHJcbiAgICBsZXQga0NvbmY6IGFueSA9IFhFVXRpbHMuaXNTdHJpbmcob3B0cykgPyB7IGtleTogb3B0cyB9IDogb3B0c1xyXG4gICAgaWYgKCFoYW5kbGVGdW5jc1tmdW5jTmFtZV0pIHtcclxuICAgICAgY29uc29sZS53YXJuKGBbdnhlLXRhYmxlLXBsdWdpbi1zaG9ydGN1dC1rZXldICcke2Z1bmNOYW1lfScgbm90IGV4aXN0LmApXHJcbiAgICB9XHJcbiAgICBzZXRLZXlRdWV1ZShzZXR0aW5nTWFwcywga0NvbmYsIGZ1bmNOYW1lKVxyXG4gIH0pXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlTGlzdGVuZXJLZXkgKG9wdGlvbnM6IFNob3J0Y3V0S2V5T3B0aW9ucykge1xyXG4gIFhFVXRpbHMuZWFjaChvcHRpb25zLmxpc3RlbmVyLCAoY2FsbGJhY2s6IEZ1bmN0aW9uLCBrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgaWYgKCFYRVV0aWxzLmlzRnVuY3Rpb24oY2FsbGJhY2spKSB7XHJcbiAgICAgIGNvbnNvbGUud2FybihgW3Z4ZS10YWJsZS1wbHVnaW4tc2hvcnRjdXQta2V5XSAnJHtrZXl9JyByZXF1aXJlcyB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gdG8gYmUgc2V0LmApXHJcbiAgICB9XHJcbiAgICBzZXRLZXlRdWV1ZShsaXN0ZW5lck1hcHMsIHsga2V5LCBjYWxsYmFjayB9KVxyXG4gIH0pXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU2hvcnRjdXRLZXlDb25mIHtcclxuICBrZXk6IHN0cmluZztcclxuICBjYWxsYmFjazogRnVuY3Rpb25cclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTaG9ydGN1dEtleUxpc3RlbmVyQ29uZmlnIHtcclxuICBbZnVuY05hbWU6IHN0cmluZ106IChwYXJhbXM6IEludGVyY2VwdG9yS2V5ZG93blBhcmFtcywgZXZudDogYW55KSA9PiBhbnk7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU2hvcnRjdXRLZXlTZXR0aW5nQ29uZmlnIHtcclxuICBbZnVuY05hbWU6IHN0cmluZ106IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTaG9ydGN1dEtleU9wdGlvbnMge1xyXG4gIGRpc2FibGVkPzogc3RyaW5nW10gfCBTaG9ydGN1dEtleUNvbmZbXTtcclxuICBsaXN0ZW5lcj86IFNob3J0Y3V0S2V5TGlzdGVuZXJDb25maWc7XHJcbiAgc2V0dGluZz86IFNob3J0Y3V0S2V5U2V0dGluZ0NvbmZpZztcclxufVxyXG5cclxuLyoqXHJcbiAqIOiuvue9ruWPguaVsFxyXG4gKiBAcGFyYW0gb3B0aW9ucyDlj4LmlbBcclxuICovXHJcbmZ1bmN0aW9uIHNldHVwIChvcHRpb25zOiBTaG9ydGN1dEtleU9wdGlvbnMpIHtcclxuICBpZiAob3B0aW9ucykge1xyXG4gICAgcGFyc2VEaXNhYmxlZEtleShvcHRpb25zKVxyXG4gICAgcGFyc2VTZXR0aW5nS2V5KG9wdGlvbnMpXHJcbiAgICBwYXJzZUxpc3RlbmVyS2V5KG9wdGlvbnMpXHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog5Z+65LqOIHZ4ZS10YWJsZSDooajmoLznmoTlop7lvLrmj5Lku7bvvIzkuLrplK7nm5jmk43kvZzmj5Dkvpvlv6vmjbfplK7nmoTorr7nva5cclxuICovXHJcbmV4cG9ydCBjb25zdCBWWEVUYWJsZVBsdWdpblNob3J0Y3V0S2V5ID0ge1xyXG4gIHNldHVwLFxyXG4gIGluc3RhbGwgKHh0YWJsZTogdHlwZW9mIFZYRVRhYmxlLCBvcHRpb25zPzogU2hvcnRjdXRLZXlPcHRpb25zKSB7XHJcbiAgICBpZiAob3B0aW9ucykge1xyXG4gICAgICBzZXR1cChvcHRpb25zKVxyXG4gICAgfVxyXG4gICAgeHRhYmxlLmludGVyY2VwdG9yLmFkZCgnZXZlbnQua2V5ZG93bicsIGhhbmRsZVNob3J0Y3V0S2V5RXZlbnQpXHJcbiAgfVxyXG59XHJcblxyXG5pZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LlZYRVRhYmxlKSB7XHJcbiAgd2luZG93LlZYRVRhYmxlLnVzZShWWEVUYWJsZVBsdWdpblNob3J0Y3V0S2V5KVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBWWEVUYWJsZVBsdWdpblNob3J0Y3V0S2V5XHJcbiJdfQ==
