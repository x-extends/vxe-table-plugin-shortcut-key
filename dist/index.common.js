"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginShortcutKey = exports.handleFuncs = exports.SKey = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var _handleFuncs;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

// import VXETable from 'vxe-table'
var arrowKeys = 'right,up,left,down'.split(',');
var specialKeys = 'alt,ctrl,shift,meta'.split(',');
var settingMaps = {};
var listenerMaps = {};
var disabledMaps = {};

var SKey =
/*#__PURE__*/
function () {
  function SKey(realKey, specialKey, funcName, kConf) {
    _classCallCheck(this, SKey);

    this.realKey = realKey;
    this.specialKey = specialKey;
    this.funcName = funcName;
    this.kConf = kConf;
  }

  _createClass(SKey, [{
    key: "trigger"
    /* TRIGGER */
    ,
    value: function trigger(params, evnt) {
      if (!this.specialKey || evnt["".concat(this.specialKey, "Key")]) {
        return handleFuncs[this.funcName](params, evnt);
      }
    }
  }, {
    key: "emit"
    /* EMIT */
    ,
    value: function emit(params, evnt) {
      if (!this.specialKey || evnt["".concat(this.specialKey, "Key")]) {
        return this.kConf.callback(params, evnt);
      }
    }
  }]);

  return SKey;
}();

exports.SKey = SKey;

function getEventKey(key) {
  if (arrowKeys.indexOf(key.toLowerCase()) > -1) {
    return "Arrow".concat(key);
  }

  return key;
}

function isTriggerPage(params) {
  var $table = params.$table;
  return !$table.getActiveRow();
}

function handleChangePage(func) {
  return function (params, evnt) {
    var $table = params.$table;
    var _$table$mouseConfig = $table.mouseConfig,
        mouseConfig = _$table$mouseConfig === void 0 ? {} : _$table$mouseConfig;
    var $grid = $table.$grid;

    if ($grid && mouseConfig.selected !== true && ['input', 'textarea'].indexOf(evnt.target.tagName.toLowerCase()) === -1 && isTriggerPage(params)) {
      var pager = $grid.$refs.pager;

      if (pager) {
        evnt.preventDefault();
        pager[func](evnt);
      }
    }
  };
}

function handleTabMove(isLeft) {
  return function (params, evnt) {
    var $table = params.$table;
    var actived = $table.getActiveRow();
    var selected = $table.getMouseSelecteds();

    if (selected) {
      $table.moveTabSelected(selected, isLeft, evnt);
    } else if (actived) {
      $table.moveTabSelected(actived, isLeft, evnt);
    }

    return false;
  };
}

function handleArrowMove(arrowIndex) {
  return function (params, evnt) {
    var $table = params.$table;
    var selected = $table.getMouseSelecteds();
    var arrows = [0, 0, 0, 0];
    arrows[arrowIndex] = 1;

    if (selected) {
      $table.moveSelected(selected, arrows[0], arrows[1], arrows[2], arrows[3], evnt);
      return false;
    }
  };
}
/**
 * 快捷键处理方法
 */


var handleFuncs = (_handleFuncs = {}, _defineProperty(_handleFuncs, "table.edit.actived"
/* TABLE_EDIT_ACTIVED */
, function tableEditActived(params, evnt) {
  var $table = params.$table;
  var selected = $table.getMouseSelecteds();

  if (selected) {
    evnt.preventDefault();
    $table.setActiveCell(selected.row, selected.column.property);
    return false;
  }
}), _defineProperty(_handleFuncs, "table.edit.closed"
/* TABLE_EDIT_CLOSED */
, function tableEditClosed(params, evnt) {
  var $table = params.$table;
  var _$table$mouseConfig2 = $table.mouseConfig,
      mouseConfig = _$table$mouseConfig2 === void 0 ? {} : _$table$mouseConfig2;
  var actived = $table.getActiveRow();

  if (actived) {
    evnt.preventDefault();
    $table.clearActived(evnt);

    if (mouseConfig.selected) {
      $table.$nextTick(function () {
        return $table.setSelectCell(actived.row, actived.column.property);
      });
    }

    return false;
  }
}), _defineProperty(_handleFuncs, "table.edit.rightTabMove"
/* TABLE_EDIT_RIGHTTABMOVE */
, handleTabMove(false)), _defineProperty(_handleFuncs, "table.edit.leftTabMove"
/* TABLE_EDIT_LEFTTABMOVE */
, handleTabMove(true)), _defineProperty(_handleFuncs, "table.cell.leftMove"
/* TABLE_CELL_LEFTMOVE */
, handleArrowMove(0)), _defineProperty(_handleFuncs, "table.cell.upMove"
/* TABLE_CELL_UPMOVE */
, handleArrowMove(1)), _defineProperty(_handleFuncs, "table.cell.rightMove"
/* TABLE_CELL_RIGHTMOVE */
, handleArrowMove(2)), _defineProperty(_handleFuncs, "table.cell.downMove"
/* TABLE_CELL_DOWNMOVE */
, handleArrowMove(3)), _defineProperty(_handleFuncs, "pager.prevPage"
/* PAGER_PREVPAGE */
, handleChangePage('prevPage')), _defineProperty(_handleFuncs, "pager.nextPage"
/* PAGER_NEXTPAGE */
, handleChangePage('nextPage')), _defineProperty(_handleFuncs, "pager.prevJump"
/* PAGER_PREVJUMP */
, handleChangePage('prevJump')), _defineProperty(_handleFuncs, "pager.nextJump"
/* PAGER_NEXTJUMP */
, handleChangePage('nextJump')), _handleFuncs);
exports.handleFuncs = handleFuncs;

function runEvent(key, maps, prop, params, evnt) {
  var skeyList = maps[key.toLowerCase()];

  if (skeyList) {
    return skeyList.some(function (skey) {
      return skey[prop](params, evnt) === false;
    });
  }
}

function handleShortcutKeyEvent(params, evnt) {
  var key = getEventKey(evnt.key);

  if (!runEvent(key, disabledMaps, "emit"
  /* EMIT */
  , params, evnt)) {
    runEvent(key, settingMaps, "trigger"
    /* TRIGGER */
    , params, evnt);
    runEvent(key, listenerMaps, "emit"
    /* EMIT */
    , params, evnt);
  }
}

function parseKeys(key) {
  var specialKey;
  var realKey;
  var keys = key.split('+');
  keys.forEach(function (item) {
    item = item.toLowerCase().trim();

    if (specialKeys.indexOf(item) > -1) {
      specialKey = item;
    } else {
      realKey = item;
    }
  });

  if (!realKey || keys.length > 2 || keys.length === 2 && !specialKey) {
    throw new Error("[vxe-table-plugin-shortcut-key] Invalid shortcut key configuration '".concat(key, "'."));
  }

  return {
    specialKey: specialKey,
    realKey: realKey
  };
}

function setKeyQueue(maps, kConf, funcName) {
  var _parseKeys = parseKeys(kConf.key),
      specialKey = _parseKeys.specialKey,
      realKey = _parseKeys.realKey;

  var skeyList = maps[realKey];

  if (!skeyList) {
    skeyList = maps[realKey] = [];
  }

  if (skeyList.some(function (skey) {
    return skey.realKey === realKey && skey.specialKey === specialKey;
  })) {
    throw new Error("[vxe-table-plugin-shortcut-key] Shortcut key conflict '".concat(kConf.key, "'."));
  }

  skeyList.push(new SKey(realKey, specialKey, funcName, kConf));
}

function parseDisabledKey(options) {
  _xeUtils["default"].each(options.disabled, function (conf) {
    var opts = _xeUtils["default"].isString(conf) ? {
      key: conf
    } : conf;
    setKeyQueue(disabledMaps, _xeUtils["default"].assign({
      callback: function callback() {
        return false;
      }
    }, opts));
  });
}

function parseSettingKey(options) {
  _xeUtils["default"].each(options.setting, function (opts, funcName) {
    var kConf = _xeUtils["default"].isString(opts) ? {
      key: opts
    } : opts;

    if (!handleFuncs[funcName]) {
      console.warn("[vxe-table-plugin-shortcut-key] '".concat(funcName, "' not exist."));
    }

    setKeyQueue(settingMaps, kConf, funcName);
  });
}

function parseListenerKey(options) {
  _xeUtils["default"].each(options.listener, function (callback, key) {
    if (!_xeUtils["default"].isFunction(callback)) {
      console.warn("[vxe-table-plugin-shortcut-key] '".concat(key, "' requires the callback function to be set."));
    }

    setKeyQueue(listenerMaps, {
      key: key,
      callback: callback
    });
  });
}
/**
 * 基于 vxe-table 表格的增强插件，为键盘操作提供快捷键的设置
 */


var VXETablePluginShortcutKey = {
  install: function install(xtable, options) {
    if (options) {
      parseDisabledKey(options);
      parseSettingKey(options);
      parseListenerKey(options);
      xtable.interceptor.add('event.keydown', handleShortcutKeyEvent);
    }
  }
};
exports.VXETablePluginShortcutKey = VXETablePluginShortcutKey;

if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginShortcutKey);
}

var _default = VXETablePluginShortcutKey;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImFycm93S2V5cyIsInNwbGl0Iiwic3BlY2lhbEtleXMiLCJzZXR0aW5nTWFwcyIsImxpc3RlbmVyTWFwcyIsImRpc2FibGVkTWFwcyIsIlNLZXkiLCJyZWFsS2V5Iiwic3BlY2lhbEtleSIsImZ1bmNOYW1lIiwia0NvbmYiLCJwYXJhbXMiLCJldm50IiwiaGFuZGxlRnVuY3MiLCJjYWxsYmFjayIsImdldEV2ZW50S2V5Iiwia2V5IiwiaW5kZXhPZiIsInRvTG93ZXJDYXNlIiwiaXNUcmlnZ2VyUGFnZSIsIiR0YWJsZSIsImdldEFjdGl2ZVJvdyIsImhhbmRsZUNoYW5nZVBhZ2UiLCJmdW5jIiwibW91c2VDb25maWciLCIkZ3JpZCIsInNlbGVjdGVkIiwidGFyZ2V0IiwidGFnTmFtZSIsInBhZ2VyIiwiJHJlZnMiLCJwcmV2ZW50RGVmYXVsdCIsImhhbmRsZVRhYk1vdmUiLCJpc0xlZnQiLCJhY3RpdmVkIiwiZ2V0TW91c2VTZWxlY3RlZHMiLCJtb3ZlVGFiU2VsZWN0ZWQiLCJoYW5kbGVBcnJvd01vdmUiLCJhcnJvd0luZGV4IiwiYXJyb3dzIiwibW92ZVNlbGVjdGVkIiwic2V0QWN0aXZlQ2VsbCIsInJvdyIsImNvbHVtbiIsInByb3BlcnR5IiwiY2xlYXJBY3RpdmVkIiwiJG5leHRUaWNrIiwic2V0U2VsZWN0Q2VsbCIsInJ1bkV2ZW50IiwibWFwcyIsInByb3AiLCJza2V5TGlzdCIsInNvbWUiLCJza2V5IiwiaGFuZGxlU2hvcnRjdXRLZXlFdmVudCIsInBhcnNlS2V5cyIsImtleXMiLCJmb3JFYWNoIiwiaXRlbSIsInRyaW0iLCJsZW5ndGgiLCJFcnJvciIsInNldEtleVF1ZXVlIiwicHVzaCIsInBhcnNlRGlzYWJsZWRLZXkiLCJvcHRpb25zIiwiWEVVdGlscyIsImVhY2giLCJkaXNhYmxlZCIsImNvbmYiLCJvcHRzIiwiaXNTdHJpbmciLCJhc3NpZ24iLCJwYXJzZVNldHRpbmdLZXkiLCJzZXR0aW5nIiwiY29uc29sZSIsIndhcm4iLCJwYXJzZUxpc3RlbmVyS2V5IiwibGlzdGVuZXIiLCJpc0Z1bmN0aW9uIiwiVlhFVGFibGVQbHVnaW5TaG9ydGN1dEtleSIsImluc3RhbGwiLCJ4dGFibGUiLCJpbnRlcmNlcHRvciIsImFkZCIsIndpbmRvdyIsIlZYRVRhYmxlIiwidXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7Ozs7Ozs7Ozs7Ozs7O0FBQ0E7QUFFQSxJQUFNQSxTQUFTLEdBQUcscUJBQXFCQyxLQUFyQixDQUEyQixHQUEzQixDQUFsQjtBQUNBLElBQU1DLFdBQVcsR0FBRyxzQkFBc0JELEtBQXRCLENBQTRCLEdBQTVCLENBQXBCO0FBQ0EsSUFBTUUsV0FBVyxHQUFHLEVBQXBCO0FBQ0EsSUFBTUMsWUFBWSxHQUFHLEVBQXJCO0FBQ0EsSUFBTUMsWUFBWSxHQUFHLEVBQXJCOztJQXNCYUMsSTs7O0FBS1gsZ0JBQWFDLE9BQWIsRUFBOEJDLFVBQTlCLEVBQWtEQyxRQUFsRCxFQUF1RUMsS0FBdkUsRUFBNkY7QUFBQTs7QUFDM0YsU0FBS0gsT0FBTCxHQUFlQSxPQUFmO0FBQ0EsU0FBS0MsVUFBTCxHQUFrQkEsVUFBbEI7QUFDQSxTQUFLQyxRQUFMLEdBQWdCQSxRQUFoQjtBQUNBLFNBQUtDLEtBQUwsR0FBYUEsS0FBYjtBQUNEOzs7U0FDRDtBQUFBOzs0QkFBcUJDLE0sRUFBYUMsSSxFQUFTO0FBQ3pDLFVBQUksQ0FBQyxLQUFLSixVQUFOLElBQW9CSSxJQUFJLFdBQUksS0FBS0osVUFBVCxTQUE1QixFQUF1RDtBQUNyRCxlQUFPSyxXQUFXLENBQUMsS0FBS0osUUFBTixDQUFYLENBQTJCRSxNQUEzQixFQUFtQ0MsSUFBbkMsQ0FBUDtBQUNEO0FBQ0Y7O1NBQ0Q7QUFBQTs7eUJBQWtCRCxNLEVBQWFDLEksRUFBUztBQUN0QyxVQUFJLENBQUMsS0FBS0osVUFBTixJQUFvQkksSUFBSSxXQUFJLEtBQUtKLFVBQVQsU0FBNUIsRUFBdUQ7QUFDckQsZUFBTyxLQUFLRSxLQUFMLENBQVdJLFFBQVgsQ0FBb0JI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QUN2Q0MsRUFBQUEsT0FEdUMsbUJBQzlCQyxNQUQ4QixFQUNqQmpCLE9BRGlCLEVBQ1c7QUFDaEQsUUFBSUEsT0FBSixFQUFhO0FBQ1hELE1BQUFBLGdCQUFnQixDQUFDQyxPQUFELENBQWhCO0FBQ0FRLE1BQUFBLGVBQWUsQ0FBQ1IsT0FBRCxDQUFmO0FBQ0FZLE1BQUFBLGdCQUFnQixDQUFDWixPQUFELENBQWhCO0FBQ0FpQixNQUFBQSxNQUFNLENBQUNDLFdBQVAsQ0FBbUJDLEdBQW5CLENBQXVCLGVBQXZCLEVBQXdDOUIsc0JBQXhDO0FBQ0Q7QUFDRjtBQVJzQyxDQUFsQzs7O0FBV1AsSUFBSSxPQUFPK0IsTUFBUCxLQUFrQixXQUFsQixJQUFpQ0EsTUFBTSxDQUFDQyxRQUE1QyxFQUFzRDtBQUNwREQsRUFBQUEsTUFBTSxDQUFDQyxRQUFQLENBQWdCQyxHQUFoQixDQUFvQlAseUJBQXBCO0FBQ0Q7O2VBRWNBLHlCIiwiZmlsZSI6ImluZGV4LmNvbW1vbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBYRVV0aWxzIGZyb20gJ3hlLXV0aWxzL21ldGhvZHMveGUtdXRpbHMnXHJcbi8vIGltcG9ydCBWWEVUYWJsZSBmcm9tICd2eGUtdGFibGUnXHJcblxyXG5jb25zdCBhcnJvd0tleXMgPSAncmlnaHQsdXAsbGVmdCxkb3duJy5zcGxpdCgnLCcpXHJcbmNvbnN0IHNwZWNpYWxLZXlzID0gJ2FsdCxjdHJsLHNoaWZ0LG1ldGEnLnNwbGl0KCcsJylcclxuY29uc3Qgc2V0dGluZ01hcHMgPSB7fVxyXG5jb25zdCBsaXN0ZW5lck1hcHMgPSB7fVxyXG5jb25zdCBkaXNhYmxlZE1hcHMgPSB7fVxyXG5cclxuZXhwb3J0IGNvbnN0IGVudW0gRlVOQ19OQU5FIHtcclxuICBUQUJMRV9FRElUX0FDVElWRUQgPSAndGFibGUuZWRpdC5hY3RpdmVkJyxcclxuICBUQUJMRV9FRElUX0NMT1NFRCA9ICd0YWJsZS5lZGl0LmNsb3NlZCcsXHJcbiAgVEFCTEVfRURJVF9SSUdIVFRBQk1PVkUgPSAndGFibGUuZWRpdC5yaWdodFRhYk1vdmUnLFxyXG4gIFRBQkxFX0VESVRfTEVGVFRBQk1PVkUgPSAndGFibGUuZWRpdC5sZWZ0VGFiTW92ZScsXHJcbiAgVEFCTEVfQ0VMTF9MRUZUTU9WRSA9ICd0YWJsZS5jZWxsLmxlZnRNb3ZlJyxcclxuICBUQUJMRV9DRUxMX1VQTU9WRSA9ICd0YWJsZS5jZWxsLnVwTW92ZScsXHJcbiAgVEFCTEVfQ0VMTF9SSUdIVE1PVkUgPSAndGFibGUuY2VsbC5yaWdodE1vdmUnLFxyXG4gIFRBQkxFX0NFTExfRE9XTk1PVkUgPSAndGFibGUuY2VsbC5kb3duTW92ZScsXHJcbiAgUEFHRVJfUFJFVlBBR0UgPSAncGFnZXIucHJldlBhZ2UnLFxyXG4gIFBBR0VSX05FWFRQQUdFID0gJ3BhZ2VyLm5leHRQYWdlJyxcclxuICBQQUdFUl9QUkVWSlVNUCA9ICdwYWdlci5wcmV2SnVtcCcsXHJcbiAgUEFHRVJfTkVYVEpVTVAgPSAncGFnZXIubmV4dEp1bXAnXHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBlbnVtIFNLRVlfTkFORSB7XHJcbiAgVFJJR0dFUiA9ICd0cmlnZ2VyJyxcclxuICBFTUlUID0gJ2VtaXQnXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBTS2V5IHtcclxuICByZWFsS2V5OiBzdHJpbmc7XHJcbiAgc3BlY2lhbEtleTogc3RyaW5nO1xyXG4gIGZ1bmNOYW1lOiBGVU5DX05BTkU7XHJcbiAga0NvbmY6IFNob3J0Y3V0S2V5Q29uZjtcclxuICBjb25zdHJ1Y3RvciAocmVhbEtleTogc3RyaW5nLCBzcGVjaWFsS2V5OiBzdHJpbmcsIGZ1bmNOYW1lOiBGVU5DX05BTkUsIGtDb25mOiBTaG9ydGN1dEtleUNvbmYpIHtcclxuICAgIHRoaXMucmVhbEtleSA9IHJlYWxLZXlcclxuICAgIHRoaXMuc3BlY2lhbEtleSA9IHNwZWNpYWxLZXlcclxuICAgIHRoaXMuZnVuY05hbWUgPSBmdW5jTmFtZVxyXG4gICAgdGhpcy5rQ29uZiA9IGtDb25mXHJcbiAgfVxyXG4gIFtTS0VZX05BTkUuVFJJR0dFUl0gKHBhcmFtczogYW55LCBldm50OiBhbnkpIHtcclxuICAgIGlmICghdGhpcy5zcGVjaWFsS2V5IHx8IGV2bnRbYCR7dGhpcy5zcGVjaWFsS2V5fUtleWBdKSB7XHJcbiAgICAgIHJldHVybiBoYW5kbGVGdW5jc1t0aGlzLmZ1bmNOYW1lXShwYXJhbXMsIGV2bnQpXHJcbiAgICB9XHJcbiAgfVxyXG4gIFtTS0VZX05BTkUuRU1JVF0gKHBhcmFtczogYW55LCBldm50OiBhbnkpIHtcclxuICAgIGlmICghdGhpcy5zcGVjaWFsS2V5IHx8IGV2bnRbYCR7dGhpcy5zcGVjaWFsS2V5fUtleWBdKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmtDb25mLmNhbGxiYWNrKHBhcmFtcywgZXZudClcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEV2ZW50S2V5IChrZXk6IHN0cmluZykge1xyXG4gIGlmIChhcnJvd0tleXMuaW5kZXhPZihrZXkudG9Mb3dlckNhc2UoKSkgPiAtMSkge1xyXG4gICAgcmV0dXJuIGBBcnJvdyR7a2V5fWBcclxuICB9XHJcbiAgcmV0dXJuIGtleVxyXG59XHJcblxyXG5mdW5jdGlvbiBpc1RyaWdnZXJQYWdlIChwYXJhbXM6IGFueSkge1xyXG4gIGNvbnN0IHsgJHRhYmxlIH0gPSBwYXJhbXNcclxuICByZXR1cm4gISR0YWJsZS5nZXRBY3RpdmVSb3coKVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVDaGFuZ2VQYWdlIChmdW5jOiBzdHJpbmcpIHtcclxuICByZXR1cm4gZnVuY3Rpb24gKHBhcmFtczogYW55LCBldm50OiBhbnkpIHtcclxuICAgIGNvbnN0IHsgJHRhYmxlIH0gPSBwYXJhbXNcclxuICAgIGNvbnN0IHsgbW91c2VDb25maWcgPSB7fSB9ID0gJHRhYmxlXHJcbiAgICBjb25zdCAkZ3JpZCA9ICR0YWJsZS4kZ3JpZFxyXG4gICAgaWYgKCRncmlkICYmIG1vdXNlQ29uZmlnLnNlbGVjdGVkICE9PSB0cnVlICYmIFsnaW5wdXQnLCAndGV4dGFyZWEnXS5pbmRleE9mKGV2bnQudGFyZ2V0LnRhZ05hbWUudG9Mb3dlckNhc2UoKSkgPT09IC0xICYmIGlzVHJpZ2dlclBhZ2UocGFyYW1zKSkge1xyXG4gICAgICBjb25zdCBwYWdlciA9ICRncmlkLiRyZWZzLnBhZ2VyXHJcbiAgICAgIGlmIChwYWdlcikge1xyXG4gICAgICAgIGV2bnQucHJldmVudERlZmF1bHQoKVxyXG4gICAgICAgIHBhZ2VyW2Z1bmNdKGV2bnQpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZVRhYk1vdmUgKGlzTGVmdDogYm9vbGVhbikge1xyXG4gIHJldHVybiBmdW5jdGlvbiAocGFyYW1zOiBhbnksIGV2bnQ6IGFueSkge1xyXG4gICAgY29uc3QgeyAkdGFibGUgfSA9IHBhcmFtc1xyXG4gICAgY29uc3QgYWN0aXZlZCA9ICR0YWJsZS5nZXRBY3RpdmVSb3coKVxyXG4gICAgY29uc3Qgc2VsZWN0ZWQgPSAkdGFibGUuZ2V0TW91c2VTZWxlY3RlZHMoKVxyXG4gICAgaWYgKHNlbGVjdGVkKSB7XHJcbiAgICAgICR0YWJsZS5tb3ZlVGFiU2VsZWN0ZWQoc2VsZWN0ZWQsIGlzTGVmdCwgZXZudClcclxuICAgIH0gZWxzZSBpZiAoYWN0aXZlZCkge1xyXG4gICAgICAkdGFibGUubW92ZVRhYlNlbGVjdGVkKGFjdGl2ZWQsIGlzTGVmdCwgZXZudClcclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlQXJyb3dNb3ZlIChhcnJvd0luZGV4OiBudW1iZXIpIHtcclxuICByZXR1cm4gZnVuY3Rpb24gKHBhcmFtczogYW55LCBldm50OiBhbnkpIHtcclxuICAgIGNvbnN0IHsgJHRhYmxlIH0gPSBwYXJhbXNcclxuICAgIGNvbnN0IHNlbGVjdGVkID0gJHRhYmxlLmdldE1vdXNlU2VsZWN0ZWRzKClcclxuICAgIGNvbnN0IGFycm93cyA9IFswLCAwLCAwLCAwXVxyXG4gICAgYXJyb3dzW2Fycm93SW5kZXhdID0gMVxyXG4gICAgaWYgKHNlbGVjdGVkKSB7XHJcbiAgICAgICR0YWJsZS5tb3ZlU2VsZWN0ZWQoc2VsZWN0ZWQsIGFycm93c1swXSwgYXJyb3dzWzFdLCBhcnJvd3NbMl0sIGFycm93c1szXSwgZXZudClcclxuICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog5b+r5o236ZSu5aSE55CG5pa55rOVXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgaGFuZGxlRnVuY3MgPSB7XHJcbiAgW0ZVTkNfTkFORS5UQUJMRV9FRElUX0FDVElWRURdIChwYXJhbXM6IGFueSwgZXZudDogYW55KSB7XHJcbiAgICBjb25zdCB7ICR0YWJsZSB9ID0gcGFyYW1zXHJcbiAgICBjb25zdCBzZWxlY3RlZCA9ICR0YWJsZS5nZXRNb3VzZVNlbGVjdGVkcygpXHJcbiAgICBpZiAoc2VsZWN0ZWQpIHtcclxuICAgICAgZXZudC5wcmV2ZW50RGVmYXVsdCgpXHJcbiAgICAgICR0YWJsZS5zZXRBY3RpdmVDZWxsKHNlbGVjdGVkLnJvdywgc2VsZWN0ZWQuY29sdW1uLnByb3BlcnR5KVxyXG4gICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuICB9LFxyXG4gIFtGVU5DX05BTkUuVEFCTEVfRURJVF9DTE9TRURdIChwYXJhbXM6IGFueSwgZXZudDogYW55KSB7XHJcbiAgICBjb25zdCB7ICR0YWJsZSB9ID0gcGFyYW1zXHJcbiAgICBjb25zdCB7IG1vdXNlQ29uZmlnID0ge30gfSA9ICR0YWJsZVxyXG4gICAgY29uc3QgYWN0aXZlZCA9ICR0YWJsZS5nZXRBY3RpdmVSb3coKVxyXG4gICAgaWYgKGFjdGl2ZWQpIHtcclxuICAgICAgZXZudC5wcmV2ZW50RGVmYXVsdCgpXHJcbiAgICAgICR0YWJsZS5jbGVhckFjdGl2ZWQoZXZudClcclxuICAgICAgaWYgKG1vdXNlQ29uZmlnLnNlbGVjdGVkKSB7XHJcbiAgICAgICAgJHRhYmxlLiRuZXh0VGljaygoKSA9PiAkdGFibGUuc2V0U2VsZWN0Q2VsbChhY3RpdmVkLnJvdywgYWN0aXZlZC5jb2x1bW4ucHJvcGVydHkpKVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG4gIH0sXHJcbiAgW0ZVTkNfTkFORS5UQUJMRV9FRElUX1JJR0hUVEFCTU9WRV06IGhhbmRsZVRhYk1vdmUoZmFsc2UpLFxyXG4gIFtGVU5DX05BTkUuVEFCTEVfRURJVF9MRUZUVEFCTU9WRV06IGhhbmRsZVRhYk1vdmUodHJ1ZSksXHJcbiAgW0ZVTkNfTkFORS5UQUJMRV9DRUxMX0xFRlRNT1ZFXTogaGFuZGxlQXJyb3dNb3ZlKDApLFxyXG4gIFtGVU5DX05BTkUuVEFCTEVfQ0VMTF9VUE1PVkVdOiBoYW5kbGVBcnJvd01vdmUoMSksXHJcbiAgW0ZVTkNfTkFORS5UQUJMRV9DRUxMX1JJR0hUTU9WRV06IGhhbmRsZUFycm93TW92ZSgyKSxcclxuICBbRlVOQ19OQU5FLlRBQkxFX0NFTExfRE9XTk1PVkVdOiBoYW5kbGVBcnJvd01vdmUoMyksXHJcbiAgW0ZVTkNfTkFORS5QQUdFUl9QUkVWUEFHRV06IGhhbmRsZUNoYW5nZVBhZ2UoJ3ByZXZQYWdlJyksXHJcbiAgW0ZVTkNfTkFORS5QQUdFUl9ORVhUUEFHRV06IGhhbmRsZUNoYW5nZVBhZ2UoJ25leHRQYWdlJyksXHJcbiAgW0ZVTkNfTkFORS5QQUdFUl9QUkVWSlVNUF06IGhhbmRsZUNoYW5nZVBhZ2UoJ3ByZXZKdW1wJyksXHJcbiAgW0ZVTkNfTkFORS5QQUdFUl9ORVhUSlVNUF06IGhhbmRsZUNoYW5nZVBhZ2UoJ25leHRKdW1wJylcclxufVxyXG5cclxuZnVuY3Rpb24gcnVuRXZlbnQgKGtleTogc3RyaW5nLCBtYXBzOiBhbnksIHByb3A6IFNLRVlfTkFORSwgcGFyYW1zOiBhbnksIGV2bnQ6IGFueSkge1xyXG4gIGxldCBza2V5TGlzdCA9IG1hcHNba2V5LnRvTG93ZXJDYXNlKCldXHJcbiAgaWYgKHNrZXlMaXN0KSB7XHJcbiAgICByZXR1cm4gc2tleUxpc3Quc29tZSgoc2tleTogU0tleSkgPT4gc2tleVtwcm9wXShwYXJhbXMsIGV2bnQpID09PSBmYWxzZSlcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZVNob3J0Y3V0S2V5RXZlbnQgKHBhcmFtczogYW55LCBldm50OiBhbnkpIHtcclxuICBsZXQga2V5ID0gZ2V0RXZlbnRLZXkoZXZudC5rZXkpXHJcbiAgaWYgKCFydW5FdmVudChrZXksIGRpc2FibGVkTWFwcywgU0tFWV9OQU5FLkVNSVQsIHBhcmFtcywgZXZudCkpIHtcclxuICAgIHJ1bkV2ZW50KGtleSwgc2V0dGluZ01hcHMsIFNLRVlfTkFORS5UUklHR0VSLCBwYXJhbXMsIGV2bnQpXHJcbiAgICBydW5FdmVudChrZXksIGxpc3RlbmVyTWFwcywgU0tFWV9OQU5FLkVNSVQsIHBhcmFtcywgZXZudClcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlS2V5cyAoa2V5OiBzdHJpbmcpIHtcclxuICBsZXQgc3BlY2lhbEtleVxyXG4gIGxldCByZWFsS2V5XHJcbiAgbGV0IGtleXMgPSBrZXkuc3BsaXQoJysnKVxyXG4gIGtleXMuZm9yRWFjaCgoaXRlbTogc3RyaW5nKSA9PiB7XHJcbiAgICBpdGVtID0gaXRlbS50b0xvd2VyQ2FzZSgpLnRyaW0oKVxyXG4gICAgaWYgKHNwZWNpYWxLZXlzLmluZGV4T2YoaXRlbSkgPiAtMSkge1xyXG4gICAgICBzcGVjaWFsS2V5ID0gaXRlbVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVhbEtleSA9IGl0ZW1cclxuICAgIH1cclxuICB9KVxyXG4gIGlmICghcmVhbEtleSB8fCBrZXlzLmxlbmd0aCA+IDIgfHwgKGtleXMubGVuZ3RoID09PSAyICYmICFzcGVjaWFsS2V5KSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKGBbdnhlLXRhYmxlLXBsdWdpbi1zaG9ydGN1dC1rZXldIEludmFsaWQgc2hvcnRjdXQga2V5IGNvbmZpZ3VyYXRpb24gJyR7a2V5fScuYClcclxuICB9XHJcbiAgcmV0dXJuIHsgc3BlY2lhbEtleSwgcmVhbEtleSB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNldEtleVF1ZXVlIChtYXBzOiBhbnksIGtDb25mOiBTaG9ydGN1dEtleUNvbmYsIGZ1bmNOYW1lPzogRlVOQ19OQU5FKSB7XHJcbiAgbGV0IHsgc3BlY2lhbEtleSwgcmVhbEtleSB9ID0gcGFyc2VLZXlzKGtDb25mLmtleSlcclxuICBsZXQgc2tleUxpc3QgPSBtYXBzW3JlYWxLZXldXHJcbiAgaWYgKCFza2V5TGlzdCkge1xyXG4gICAgc2tleUxpc3QgPSBtYXBzW3JlYWxLZXldID0gW11cclxuICB9XHJcbiAgaWYgKHNrZXlMaXN0LnNvbWUoKHNrZXk6IFNLZXkpID0+IHNrZXkucmVhbEtleSA9PT0gcmVhbEtleSAmJiBza2V5LnNwZWNpYWxLZXkgPT09IHNwZWNpYWxLZXkpKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFt2eGUtdGFibGUtcGx1Z2luLXNob3J0Y3V0LWtleV0gU2hvcnRjdXQga2V5IGNvbmZsaWN0ICcke2tDb25mLmtleX0nLmApXHJcbiAgfVxyXG4gIHNrZXlMaXN0LnB1c2gobmV3IFNLZXkocmVhbEtleSwgc3BlY2lhbEtleSwgZnVuY05hbWUsIGtDb25mKSlcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VEaXNhYmxlZEtleSAob3B0aW9uczogU2hvcnRjdXRLZXlPcHRpb25zKSB7XHJcbiAgWEVVdGlscy5lYWNoKG9wdGlvbnMuZGlzYWJsZWQsIChjb25mOiBhbnkpID0+IHtcclxuICAgIGxldCBvcHRzID0gWEVVdGlscy5pc1N0cmluZyhjb25mKSA/IHsga2V5OiBjb25mIH0gOiBjb25mXHJcbiAgICBzZXRLZXlRdWV1ZShkaXNhYmxlZE1hcHMsIFhFVXRpbHMuYXNzaWduKHsgY2FsbGJhY2s6ICgpID0+IGZhbHNlIH0sIG9wdHMpKVxyXG4gIH0pXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlU2V0dGluZ0tleSAob3B0aW9uczogU2hvcnRjdXRLZXlPcHRpb25zKSB7XHJcbiAgWEVVdGlscy5lYWNoKG9wdGlvbnMuc2V0dGluZywgKG9wdHM6IGFueSwgZnVuY05hbWU6IEZVTkNfTkFORSkgPT4ge1xyXG4gICAgbGV0IGtDb25mID0gWEVVdGlscy5pc1N0cmluZyhvcHRzKSA/IHsga2V5OiBvcHRzIH0gOiBvcHRzXHJcbiAgICBpZiAoIWhhbmRsZUZ1bmNzW2Z1bmNOYW1lXSkge1xyXG4gICAgICBjb25zb2xlLndhcm4oYFt2eGUtdGFibGUtcGx1Z2luLXNob3J0Y3V0LWtleV0gJyR7ZnVuY05hbWV9JyBub3QgZXhpc3QuYClcclxuICAgIH1cclxuICAgIHNldEtleVF1ZXVlKHNldHRpbmdNYXBzLCBrQ29uZiwgZnVuY05hbWUpXHJcbiAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VMaXN0ZW5lcktleSAob3B0aW9uczogU2hvcnRjdXRLZXlPcHRpb25zKSB7XHJcbiAgWEVVdGlscy5lYWNoKG9wdGlvbnMubGlzdGVuZXIsIChjYWxsYmFjazogRnVuY3Rpb24sIGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICBpZiAoIVhFVXRpbHMuaXNGdW5jdGlvbihjYWxsYmFjaykpIHtcclxuICAgICAgY29uc29sZS53YXJuKGBbdnhlLXRhYmxlLXBsdWdpbi1zaG9ydGN1dC1rZXldICcke2tleX0nIHJlcXVpcmVzIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB0byBiZSBzZXQuYClcclxuICAgIH1cclxuICAgIHNldEtleVF1ZXVlKGxpc3RlbmVyTWFwcywgeyBrZXksIGNhbGxiYWNrIH0pXHJcbiAgfSlcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTaG9ydGN1dEtleUNvbmYge1xyXG4gIGtleT86IHN0cmluZztcclxuICBjYWxsYmFjaz86IEZ1bmN0aW9uXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU2hvcnRjdXRLZXlPcHRpb25zIHtcclxuICBkaXNhYmxlZDogc3RyaW5nIHwgQXJyYXk8U2hvcnRjdXRLZXlDb25mPjtcclxuICBsaXN0ZW5lcjogb2JqZWN0O1xyXG4gIHNldHRpbmc6IG9iamVjdDtcclxufVxyXG5cclxuLyoqXHJcbiAqIOWfuuS6jiB2eGUtdGFibGUg6KGo5qC855qE5aKe5by65o+S5Lu277yM5Li66ZSu55uY5pON5L2c5o+Q5L6b5b+r5o236ZSu55qE6K6+572uXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgVlhFVGFibGVQbHVnaW5TaG9ydGN1dEtleSA9IHtcclxuICBpbnN0YWxsICh4dGFibGU6IGFueSwgb3B0aW9ucz86IFNob3J0Y3V0S2V5T3B0aW9ucykge1xyXG4gICAgaWYgKG9wdGlvbnMpIHtcclxuICAgICAgcGFyc2VEaXNhYmxlZEtleShvcHRpb25zKVxyXG4gICAgICBwYXJzZVNldHRpbmdLZXkob3B0aW9ucylcclxuICAgICAgcGFyc2VMaXN0ZW5lcktleShvcHRpb25zKVxyXG4gICAgICB4dGFibGUuaW50ZXJjZXB0b3IuYWRkKCdldmVudC5rZXlkb3duJywgaGFuZGxlU2hvcnRjdXRLZXlFdmVudClcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuVlhFVGFibGUpIHtcclxuICB3aW5kb3cuVlhFVGFibGUudXNlKFZYRVRhYmxlUGx1Z2luU2hvcnRjdXRLZXkpXHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IFZYRVRhYmxlUGx1Z2luU2hvcnRjdXRLZXlcclxuIl19
