"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginShortcutKey = exports.handleFuncs = exports.SKey = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils"));

var _handleFuncs;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var arrowKeys = 'right,up,left,down'.split(',');
var specialKeys = 'alt,ctrl,shift,meta'.split(',');
var settingMaps = {};
var listenerMaps = {};
var disabledMaps = {};

var SKey =
/*#__PURE__*/
function () {
  function SKey(realKey, specialKey, funcName, kConf) {
    _classCallCheck(this, SKey);

    this.realKey = realKey;
    this.specialKey = specialKey;
    this.funcName = funcName;
    this.kConf = kConf;
  }

  _createClass(SKey, [{
    key: "trigger"
    /* TRIGGER */
    ,
    value: function trigger(params, evnt) {
      if (!this.specialKey || evnt["".concat(this.specialKey, "Key")]) {
        if (this.funcName) {
          return handleFuncs[this.funcName](params, evnt);
        }
      }
    }
  }, {
    key: "emit"
    /* EMIT */
    ,
    value: function emit(params, evnt) {
      if (!this.specialKey || evnt["".concat(this.specialKey, "Key")]) {
        if (this.kConf) {
          return this.kConf.callback(params, evnt);
        }
      }
    }
  }]);

  return SKey;
}();

exports.SKey = SKey;

function getEventKey(key) {
  if (arrowKeys.indexOf(key.toLowerCase()) > -1) {
    return "Arrow".concat(key);
  }

  return key;
}

function isTriggerPage(params) {
  var $table = params.$table;
  return !$table.getActiveRow();
}

function handleChangePage(func) {
  return function (params, evnt) {
    var $table = params.$table;
    var _$table$mouseConfig = $table.mouseConfig,
        mouseConfig = _$table$mouseConfig === void 0 ? {} : _$table$mouseConfig;
    var $grid = $table.$grid;

    if ($grid && mouseConfig.selected !== true && ['input', 'textarea'].indexOf(evnt.target.tagName.toLowerCase()) === -1 && isTriggerPage(params)) {
      var pager = $grid.$refs.pager;

      if (pager) {
        evnt.preventDefault();
        pager[func](evnt);
      }
    }
  };
}

function handleTabMove(isLeft) {
  return function (params, evnt) {
    var $table = params.$table;
    var actived = $table.getActiveRow();
    var selected = $table.getMouseSelecteds();

    if (selected) {
      $table.moveTabSelected(selected, isLeft, evnt);
    } else if (actived) {
      $table.moveTabSelected(actived, isLeft, evnt);
    }

    return false;
  };
}

function handleArrowMove(arrowIndex) {
  return function (params, evnt) {
    var $table = params.$table;
    var selected = $table.getMouseSelecteds();
    var arrows = [0, 0, 0, 0];
    arrows[arrowIndex] = 1;

    if (selected) {
      $table.moveSelected(selected, arrows[0], arrows[1], arrows[2], arrows[3], evnt);
      return false;
    }
  };
}
/**
 * 快捷键处理方法
 */


var handleFuncs = (_handleFuncs = {}, _defineProperty(_handleFuncs, "table.edit.actived"
/* TABLE_EDIT_ACTIVED */
, function tableEditActived(params, evnt) {
  var $table = params.$table;
  var selected = $table.getMouseSelecteds();

  if (selected) {
    evnt.preventDefault();
    $table.setActiveCell(selected.row, selected.column.property);
    return false;
  }
}), _defineProperty(_handleFuncs, "table.edit.closed"
/* TABLE_EDIT_CLOSED */
, function tableEditClosed(params, evnt) {
  var $table = params.$table;
  var _$table$mouseConfig2 = $table.mouseConfig,
      mouseConfig = _$table$mouseConfig2 === void 0 ? {} : _$table$mouseConfig2;
  var actived = $table.getActiveRow();

  if (actived) {
    evnt.preventDefault();
    $table.clearActived(evnt);

    if (mouseConfig.selected) {
      $table.$nextTick(function () {
        return $table.setSelectCell(actived.row, actived.column.property);
      });
    }

    return false;
  }
}), _defineProperty(_handleFuncs, "table.edit.rightTabMove"
/* TABLE_EDIT_RIGHTTABMOVE */
, handleTabMove(false)), _defineProperty(_handleFuncs, "table.edit.leftTabMove"
/* TABLE_EDIT_LEFTTABMOVE */
, handleTabMove(true)), _defineProperty(_handleFuncs, "table.cell.leftMove"
/* TABLE_CELL_LEFTMOVE */
, handleArrowMove(0)), _defineProperty(_handleFuncs, "table.cell.upMove"
/* TABLE_CELL_UPMOVE */
, handleArrowMove(1)), _defineProperty(_handleFuncs, "table.cell.rightMove"
/* TABLE_CELL_RIGHTMOVE */
, handleArrowMove(2)), _defineProperty(_handleFuncs, "table.cell.downMove"
/* TABLE_CELL_DOWNMOVE */
, handleArrowMove(3)), _defineProperty(_handleFuncs, "pager.prevPage"
/* PAGER_PREVPAGE */
, handleChangePage('prevPage')), _defineProperty(_handleFuncs, "pager.nextPage"
/* PAGER_NEXTPAGE */
, handleChangePage('nextPage')), _defineProperty(_handleFuncs, "pager.prevJump"
/* PAGER_PREVJUMP */
, handleChangePage('prevJump')), _defineProperty(_handleFuncs, "pager.nextJump"
/* PAGER_NEXTJUMP */
, handleChangePage('nextJump')), _handleFuncs);
exports.handleFuncs = handleFuncs;

function runEvent(key, maps, prop, params, evnt) {
  var skeyList = maps[key.toLowerCase()];

  if (skeyList) {
    return skeyList.some(function (skey) {
      return skey[prop](params, evnt) === false;
    });
  }
}

function handleShortcutKeyEvent(params, evnt) {
  var key = getEventKey(evnt.key);

  if (!runEvent(key, disabledMaps, "emit"
  /* EMIT */
  , params, evnt)) {
    runEvent(key, settingMaps, "trigger"
    /* TRIGGER */
    , params, evnt);
    runEvent(key, listenerMaps, "emit"
    /* EMIT */
    , params, evnt);
  }
}

function parseKeys(key) {
  var specialKey = '';
  var realKey = '';
  var keys = key.split('+');
  keys.forEach(function (item) {
    item = item.toLowerCase().trim();

    if (specialKeys.indexOf(item) > -1) {
      specialKey = item;
    } else {
      realKey = item;
    }
  });

  if (!realKey || keys.length > 2 || keys.length === 2 && !specialKey) {
    throw new Error("[vxe-table-plugin-shortcut-key] Invalid shortcut key configuration '".concat(key, "'."));
  }

  return {
    realKey: realKey,
    specialKey: specialKey
  };
}

function setKeyQueue(maps, kConf, funcName) {
  var _parseKeys = parseKeys(kConf.key),
      realKey = _parseKeys.realKey,
      specialKey = _parseKeys.specialKey;

  var skeyList = maps[realKey];

  if (!skeyList) {
    skeyList = maps[realKey] = [];
  }

  if (skeyList.some(function (skey) {
    return skey.realKey === realKey && skey.specialKey === specialKey;
  })) {
    throw new Error("[vxe-table-plugin-shortcut-key] Shortcut key conflict '".concat(kConf.key, "'."));
  }

  skeyList.push(new SKey(realKey, specialKey, funcName, kConf));
}

function parseDisabledKey(options) {
  _xeUtils["default"].each(options.disabled, function (conf) {
    var opts = _xeUtils["default"].isString(conf) ? {
      key: conf
    } : conf;
    setKeyQueue(disabledMaps, _xeUtils["default"].assign({
      callback: function callback() {
        return false;
      }
    }, opts));
  });
}

function parseSettingKey(options) {
  _xeUtils["default"].each(options.setting, function (opts, funcName) {
    var kConf = _xeUtils["default"].isString(opts) ? {
      key: opts
    } : opts;

    if (!handleFuncs[funcName]) {
      console.warn("[vxe-table-plugin-shortcut-key] '".concat(funcName, "' not exist."));
    }

    setKeyQueue(settingMaps, kConf, funcName);
  });
}

function parseListenerKey(options) {
  _xeUtils["default"].each(options.listener, function (callback, key) {
    if (!_xeUtils["default"].isFunction(callback)) {
      console.warn("[vxe-table-plugin-shortcut-key] '".concat(key, "' requires the callback function to be set."));
    }

    setKeyQueue(listenerMaps, {
      key: key,
      callback: callback
    });
  });
}
/**
 * 基于 vxe-table 表格的增强插件，为键盘操作提供快捷键的设置
 */


var VXETablePluginShortcutKey = {
  install: function install(xtable, options) {
    if (options) {
      parseDisabledKey(options);
      parseSettingKey(options);
      parseListenerKey(options);
      xtable.interceptor.add('event.keydown', handleShortcutKeyEvent);
    }
  }
};
exports.VXETablePluginShortcutKey = VXETablePluginShortcutKey;

if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginShortcutKey);
}

var _default = VXETablePluginShortcutKey;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImFycm93S2V5cyIsInNwbGl0Iiwic3BlY2lhbEtleXMiLCJzZXR0aW5nTWFwcyIsImxpc3RlbmVyTWFwcyIsImRpc2FibGVkTWFwcyIsIlNLZXkiLCJyZWFsS2V5Iiwic3BlY2lhbEtleSIsImZ1bmNOYW1lIiwia0NvbmYiLCJwYXJhbXMiLCJldm50IiwiaGFuZGxlRnVuY3MiLCJjYWxsYmFjayIsImdldEV2ZW50S2V5Iiwia2V5IiwiaW5kZXhPZiIsInRvTG93ZXJDYXNlIiwiaXNUcmlnZ2VyUGFnZSIsIiR0YWJsZSIsImdldEFjdGl2ZVJvdyIsImhhbmRsZUNoYW5nZVBhZ2UiLCJmdW5jIiwibW91c2VDb25maWciLCIkZ3JpZCIsInNlbGVjdGVkIiwidGFyZ2V0IiwidGFnTmFtZSIsInBhZ2VyIiwiJHJlZnMiLCJwcmV2ZW50RGVmYXVsdCIsImhhbmRsZVRhYk1vdmUiLCJpc0xlZnQiLCJhY3RpdmVkIiwiZ2V0TW91c2VTZWxlY3RlZHMiLCJtb3ZlVGFiU2VsZWN0ZWQiLCJoYW5kbGVBcnJvd01vdmUiLCJhcnJvd0luZGV4IiwiYXJyb3dzIiwibW92ZVNlbGVjdGVkIiwic2V0QWN0aXZlQ2VsbCIsInJvdyIsImNvbHVtbiIsInByb3BlcnR5IiwiY2xlYXJBY3RpdmVkIiwiJG5leHRUaWNrIiwic2V0U2VsZWN0Q2VsbCIsInJ1bkV2ZW50IiwibWFwcyIsInByb3AiLCJza2V5TGlzdCIsInNvbWUiLCJza2V5IiwiaGFuZGxlU2hvcnRjdXRLZXlFdmVudCIsInBhcnNlS2V5cyIsImtleXMiLCJmb3JFYWNoIiwiaXRlbSIsInRyaW0iLCJsZW5ndGgiLCJFcnJvciIsInNldEtleVF1ZXVlIiwicHVzaCIsInBhcnNlRGlzYWJsZWRLZXkiLCJvcHRpb25zIiwiWEVVdGlscyIsImVhY2giLCJkaXNhYmxlZCIsImNvbmYiLCJvcHRzIiwiaXNTdHJpbmciLCJhc3NpZ24iLCJwYXJzZVNldHRpbmdLZXkiLCJzZXR0aW5nIiwiY29uc29sZSIsIndhcm4iLCJwYXJzZUxpc3RlbmVyS2V5IiwibGlzdGVuZXIiLCJpc0Z1bmN0aW9uIiwiVlhFVGFibGVQbHVnaW5TaG9ydGN1dEtleSIsImluc3RhbGwiLCJ4dGFibGUiLCJpbnRlcmNlcHRvciIsImFkZCIsIndpbmRvdyIsIlZYRVRhYmxlIiwidXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7Ozs7Ozs7Ozs7Ozs7O0FBT0EsSUFBTUEsU0FBUyxHQUFHLHFCQUFxQkMsS0FBckIsQ0FBMkIsR0FBM0IsQ0FBbEI7QUFDQSxJQUFNQyxXQUFXLEdBQUcsc0JBQXNCRCxLQUF0QixDQUE0QixHQUE1QixDQUFwQjtBQUNBLElBQU1FLFdBQVcsR0FBaUIsRUFBbEM7QUFDQSxJQUFNQyxZQUFZLEdBQWlCLEVBQW5DO0FBQ0EsSUFBTUMsWUFBWSxHQUFpQixFQUFuQzs7SUFzQmFDLEk7OztBQUtYLGdCQUFhQyxPQUFiLEVBQThCQyxVQUE5QixFQUFrREMsUUFBbEQsRUFBd0VDLEtBQXhFLEVBQStGO0FBQUE7O0FBQzdGLFNBQUtILE9BQUwsR0FBZUEsT0FBZjtBQUNBLFNBQUtDLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQkEsUUFBaEI7QUFDQSxTQUFLQyxLQUFMLEdBQWFBLEtBQWI7QUFDRDs7O1NBQ0Q7QUFBQTs7NEJBQXFCQyxNLEVBQWFDLEksRUFBUztBQUN6QyxVQUFJLENBQUMsS0FBS0osVUFBTixJQUFvQkksSUFBSSxXQUFJLEtBQUtKLFVBQVQsU0FBNUIsRUFBdUQ7QUFDckQsWUFBSSxLQUFLQyxRQUFULEVBQW1CO0FBQ2pCLGlCQUFPSSxXQUFXLENBQUMsS0FBS0osUUFBTixDQUFYLENBQTJCRSxNQUEzQixFQUFtQ0MsSUFBbkMsQ0FBUDtBQUNEO0FBQ0Y7QUFDRjs7U0FDRDtBQUFBOzt5QkFBa0JELE0sRUFBYUMsSSxFQUFTO0FBQ3RDLFVBQUksQ0FBQyxLQUFLSixVQUFOLElBQW9CSSxJQUFJLFdBQUksS0FBS0osVUFBVCxTQUE1QixFQUF1RDtBQUNyRCxZ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QUFPRixNQUFBQSxRQUFRLEVBQVJBO0FBQVAsS0FBZixDQUFYO0FBQ0QsR0FMRDtBQU1EO0FBYUQ7Ozs7O0FBR08sSUFBTWtFLHlCQUF5QixHQUFHO0FBQ3ZDQyxFQUFBQSxPQUR1QyxtQkFDOUJDLE1BRDhCLEVBQ0xqQixPQURLLEVBQ3VCO0FBQzVELFFBQUlBLE9BQUosRUFBYTtBQUNYRCxNQUFBQSxnQkFBZ0IsQ0FBQ0MsT0FBRCxDQUFoQjtBQUNBUSxNQUFBQSxlQUFlLENBQUNSLE9BQUQsQ0FBZjtBQUNBWSxNQUFBQSxnQkFBZ0IsQ0FBQ1osT0FBRCxDQUFoQjtBQUNBaUIsTUFBQUEsTUFBTSxDQUFDQyxXQUFQLENBQW1CQyxHQUFuQixDQUF1QixlQUF2QixFQUF3QzlCLHNCQUF4QztBQUNEO0FBQ0Y7QUFSc0MsQ0FBbEM7OztBQVdQLElBQUksT0FBTytCLE1BQVAsS0FBa0IsV0FBbEIsSUFBaUNBLE1BQU0sQ0FBQ0MsUUFBNUMsRUFBc0Q7QUFDcERELEVBQUFBLE1BQU0sQ0FBQ0MsUUFBUCxDQUFnQkMsR0FBaEIsQ0FBb0JQLHlCQUFwQjtBQUNEOztlQUVjQSx5QiIsImZpbGUiOiJpbmRleC5jb21tb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgWEVVdGlscyBmcm9tICd4ZS11dGlscydcclxuaW1wb3J0IFZYRVRhYmxlIGZyb20gJ3Z4ZS10YWJsZS9saWIvdnhlLXRhYmxlJ1xyXG5cclxuaW50ZXJmYWNlIEtleVN0b3JlTWFwcyB7XHJcbiAgW3Byb3BOYW1lOiBzdHJpbmddOiBhbnlbXTtcclxufVxyXG5cclxuY29uc3QgYXJyb3dLZXlzID0gJ3JpZ2h0LHVwLGxlZnQsZG93bicuc3BsaXQoJywnKVxyXG5jb25zdCBzcGVjaWFsS2V5cyA9ICdhbHQsY3RybCxzaGlmdCxtZXRhJy5zcGxpdCgnLCcpXHJcbmNvbnN0IHNldHRpbmdNYXBzOiBLZXlTdG9yZU1hcHMgPSB7fVxyXG5jb25zdCBsaXN0ZW5lck1hcHM6IEtleVN0b3JlTWFwcyA9IHt9XHJcbmNvbnN0IGRpc2FibGVkTWFwczogS2V5U3RvcmVNYXBzID0ge31cclxuXHJcbmV4cG9ydCBjb25zdCBlbnVtIEZVTkNfTkFORSB7XHJcbiAgVEFCTEVfRURJVF9BQ1RJVkVEID0gJ3RhYmxlLmVkaXQuYWN0aXZlZCcsXHJcbiAgVEFCTEVfRURJVF9DTE9TRUQgPSAndGFibGUuZWRpdC5jbG9zZWQnLFxyXG4gIFRBQkxFX0VESVRfUklHSFRUQUJNT1ZFID0gJ3RhYmxlLmVkaXQucmlnaHRUYWJNb3ZlJyxcclxuICBUQUJMRV9FRElUX0xFRlRUQUJNT1ZFID0gJ3RhYmxlLmVkaXQubGVmdFRhYk1vdmUnLFxyXG4gIFRBQkxFX0NFTExfTEVGVE1PVkUgPSAndGFibGUuY2VsbC5sZWZ0TW92ZScsXHJcbiAgVEFCTEVfQ0VMTF9VUE1PVkUgPSAndGFibGUuY2VsbC51cE1vdmUnLFxyXG4gIFRBQkxFX0NFTExfUklHSFRNT1ZFID0gJ3RhYmxlLmNlbGwucmlnaHRNb3ZlJyxcclxuICBUQUJMRV9DRUxMX0RPV05NT1ZFID0gJ3RhYmxlLmNlbGwuZG93bk1vdmUnLFxyXG4gIFBBR0VSX1BSRVZQQUdFID0gJ3BhZ2VyLnByZXZQYWdlJyxcclxuICBQQUdFUl9ORVhUUEFHRSA9ICdwYWdlci5uZXh0UGFnZScsXHJcbiAgUEFHRVJfUFJFVkpVTVAgPSAncGFnZXIucHJldkp1bXAnLFxyXG4gIFBBR0VSX05FWFRKVU1QID0gJ3BhZ2VyLm5leHRKdW1wJ1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgZW51bSBTS0VZX05BTkUge1xyXG4gIFRSSUdHRVIgPSAndHJpZ2dlcicsXHJcbiAgRU1JVCA9ICdlbWl0J1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgU0tleSB7XHJcbiAgcmVhbEtleTogc3RyaW5nO1xyXG4gIHNwZWNpYWxLZXk6IHN0cmluZztcclxuICBmdW5jTmFtZT86IEZVTkNfTkFORTtcclxuICBrQ29uZj86IFNob3J0Y3V0S2V5Q29uZjtcclxuICBjb25zdHJ1Y3RvciAocmVhbEtleTogc3RyaW5nLCBzcGVjaWFsS2V5OiBzdHJpbmcsIGZ1bmNOYW1lPzogRlVOQ19OQU5FLCBrQ29uZj86IFNob3J0Y3V0S2V5Q29uZikge1xyXG4gICAgdGhpcy5yZWFsS2V5ID0gcmVhbEtleVxyXG4gICAgdGhpcy5zcGVjaWFsS2V5ID0gc3BlY2lhbEtleVxyXG4gICAgdGhpcy5mdW5jTmFtZSA9IGZ1bmNOYW1lXHJcbiAgICB0aGlzLmtDb25mID0ga0NvbmZcclxuICB9XHJcbiAgW1NLRVlfTkFORS5UUklHR0VSXSAocGFyYW1zOiBhbnksIGV2bnQ6IGFueSkge1xyXG4gICAgaWYgKCF0aGlzLnNwZWNpYWxLZXkgfHwgZXZudFtgJHt0aGlzLnNwZWNpYWxLZXl9S2V5YF0pIHtcclxuICAgICAgaWYgKHRoaXMuZnVuY05hbWUpIHtcclxuICAgICAgICByZXR1cm4gaGFuZGxlRnVuY3NbdGhpcy5mdW5jTmFtZV0ocGFyYW1zLCBldm50KVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIFtTS0VZX05BTkUuRU1JVF0gKHBhcmFtczogYW55LCBldm50OiBhbnkpIHtcclxuICAgIGlmICghdGhpcy5zcGVjaWFsS2V5IHx8IGV2bnRbYCR7dGhpcy5zcGVjaWFsS2V5fUtleWBdKSB7XHJcbiAgICAgIGlmICh0aGlzLmtDb25mKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMua0NvbmYuY2FsbGJhY2socGFyYW1zLCBldm50KVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRFdmVudEtleSAoa2V5OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gIGlmIChhcnJvd0tleXMuaW5kZXhPZihrZXkudG9Mb3dlckNhc2UoKSkgPiAtMSkge1xyXG4gICAgcmV0dXJuIGBBcnJvdyR7a2V5fWBcclxuICB9XHJcbiAgcmV0dXJuIGtleVxyXG59XHJcblxyXG5mdW5jdGlvbiBpc1RyaWdnZXJQYWdlIChwYXJhbXM6IGFueSk6IGJvb2xlYW4ge1xyXG4gIGNvbnN0IHsgJHRhYmxlIH0gPSBwYXJhbXNcclxuICByZXR1cm4gISR0YWJsZS5nZXRBY3RpdmVSb3coKVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVDaGFuZ2VQYWdlIChmdW5jOiBzdHJpbmcpIHtcclxuICByZXR1cm4gZnVuY3Rpb24gKHBhcmFtczogYW55LCBldm50OiBhbnkpOiBhbnkge1xyXG4gICAgY29uc3QgeyAkdGFibGUgfSA9IHBhcmFtc1xyXG4gICAgY29uc3QgeyBtb3VzZUNvbmZpZyA9IHt9IH0gPSAkdGFibGVcclxuICAgIGNvbnN0ICRncmlkID0gJHRhYmxlLiRncmlkXHJcbiAgICBpZiAoJGdyaWQgJiYgbW91c2VDb25maWcuc2VsZWN0ZWQgIT09IHRydWUgJiYgWydpbnB1dCcsICd0ZXh0YXJlYSddLmluZGV4T2YoZXZudC50YXJnZXQudGFnTmFtZS50b0xvd2VyQ2FzZSgpKSA9PT0gLTEgJiYgaXNUcmlnZ2VyUGFnZShwYXJhbXMpKSB7XHJcbiAgICAgIGNvbnN0IHBhZ2VyID0gJGdyaWQuJHJlZnMucGFnZXJcclxuICAgICAgaWYgKHBhZ2VyKSB7XHJcbiAgICAgICAgZXZudC5wcmV2ZW50RGVmYXVsdCgpXHJcbiAgICAgICAgcGFnZXJbZnVuY10oZXZudClcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlVGFiTW92ZSAoaXNMZWZ0OiBib29sZWFuKSB7XHJcbiAgcmV0dXJuIGZ1bmN0aW9uIChwYXJhbXM6IGFueSwgZXZudDogYW55KTogYW55IHtcclxuICAgIGNvbnN0IHsgJHRhYmxlIH0gPSBwYXJhbXNcclxuICAgIGNvbnN0IGFjdGl2ZWQgPSAkdGFibGUuZ2V0QWN0aXZlUm93KClcclxuICAgIGNvbnN0IHNlbGVjdGVkID0gJHRhYmxlLmdldE1vdXNlU2VsZWN0ZWRzKClcclxuICAgIGlmIChzZWxlY3RlZCkge1xyXG4gICAgICAkdGFibGUubW92ZVRhYlNlbGVjdGVkKHNlbGVjdGVkLCBpc0xlZnQsIGV2bnQpXHJcbiAgICB9IGVsc2UgaWYgKGFjdGl2ZWQpIHtcclxuICAgICAgJHRhYmxlLm1vdmVUYWJTZWxlY3RlZChhY3RpdmVkLCBpc0xlZnQsIGV2bnQpXHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUFycm93TW92ZSAoYXJyb3dJbmRleDogbnVtYmVyKSB7XHJcbiAgcmV0dXJuIGZ1bmN0aW9uIChwYXJhbXM6IGFueSwgZXZudDogYW55KTogYW55IHtcclxuICAgIGNvbnN0IHsgJHRhYmxlIH0gPSBwYXJhbXNcclxuICAgIGNvbnN0IHNlbGVjdGVkID0gJHRhYmxlLmdldE1vdXNlU2VsZWN0ZWRzKClcclxuICAgIGNvbnN0IGFycm93cyA9IFswLCAwLCAwLCAwXVxyXG4gICAgYXJyb3dzW2Fycm93SW5kZXhdID0gMVxyXG4gICAgaWYgKHNlbGVjdGVkKSB7XHJcbiAgICAgICR0YWJsZS5tb3ZlU2VsZWN0ZWQoc2VsZWN0ZWQsIGFycm93c1swXSwgYXJyb3dzWzFdLCBhcnJvd3NbMl0sIGFycm93c1szXSwgZXZudClcclxuICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog5b+r5o236ZSu5aSE55CG5pa55rOVXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgaGFuZGxlRnVuY3MgPSB7XHJcbiAgW0ZVTkNfTkFORS5UQUJMRV9FRElUX0FDVElWRURdIChwYXJhbXM6IGFueSwgZXZudDogYW55KTogYW55IHtcclxuICAgIGNvbnN0IHsgJHRhYmxlIH0gPSBwYXJhbXNcclxuICAgIGNvbnN0IHNlbGVjdGVkID0gJHRhYmxlLmdldE1vdXNlU2VsZWN0ZWRzKClcclxuICAgIGlmIChzZWxlY3RlZCkge1xyXG4gICAgICBldm50LnByZXZlbnREZWZhdWx0KClcclxuICAgICAgJHRhYmxlLnNldEFjdGl2ZUNlbGwoc2VsZWN0ZWQucm93LCBzZWxlY3RlZC5jb2x1bW4ucHJvcGVydHkpXHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG4gIH0sXHJcbiAgW0ZVTkNfTkFORS5UQUJMRV9FRElUX0NMT1NFRF0gKHBhcmFtczogYW55LCBldm50OiBhbnkpOiBhbnkge1xyXG4gICAgY29uc3QgeyAkdGFibGUgfSA9IHBhcmFtc1xyXG4gICAgY29uc3QgeyBtb3VzZUNvbmZpZyA9IHt9IH0gPSAkdGFibGVcclxuICAgIGNvbnN0IGFjdGl2ZWQgPSAkdGFibGUuZ2V0QWN0aXZlUm93KClcclxuICAgIGlmIChhY3RpdmVkKSB7XHJcbiAgICAgIGV2bnQucHJldmVudERlZmF1bHQoKVxyXG4gICAgICAkdGFibGUuY2xlYXJBY3RpdmVkKGV2bnQpXHJcbiAgICAgIGlmIChtb3VzZUNvbmZpZy5zZWxlY3RlZCkge1xyXG4gICAgICAgICR0YWJsZS4kbmV4dFRpY2soKCkgPT4gJHRhYmxlLnNldFNlbGVjdENlbGwoYWN0aXZlZC5yb3csIGFjdGl2ZWQuY29sdW1uLnByb3BlcnR5KSlcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuICB9LFxyXG4gIFtGVU5DX05BTkUuVEFCTEVfRURJVF9SSUdIVFRBQk1PVkVdOiBoYW5kbGVUYWJNb3ZlKGZhbHNlKSxcclxuICBbRlVOQ19OQU5FLlRBQkxFX0VESVRfTEVGVFRBQk1PVkVdOiBoYW5kbGVUYWJNb3ZlKHRydWUpLFxyXG4gIFtGVU5DX05BTkUuVEFCTEVfQ0VMTF9MRUZUTU9WRV06IGhhbmRsZUFycm93TW92ZSgwKSxcclxuICBbRlVOQ19OQU5FLlRBQkxFX0NFTExfVVBNT1ZFXTogaGFuZGxlQXJyb3dNb3ZlKDEpLFxyXG4gIFtGVU5DX05BTkUuVEFCTEVfQ0VMTF9SSUdIVE1PVkVdOiBoYW5kbGVBcnJvd01vdmUoMiksXHJcbiAgW0ZVTkNfTkFORS5UQUJMRV9DRUxMX0RPV05NT1ZFXTogaGFuZGxlQXJyb3dNb3ZlKDMpLFxyXG4gIFtGVU5DX05BTkUuUEFHRVJfUFJFVlBBR0VdOiBoYW5kbGVDaGFuZ2VQYWdlKCdwcmV2UGFnZScpLFxyXG4gIFtGVU5DX05BTkUuUEFHRVJfTkVYVFBBR0VdOiBoYW5kbGVDaGFuZ2VQYWdlKCduZXh0UGFnZScpLFxyXG4gIFtGVU5DX05BTkUuUEFHRVJfUFJFVkpVTVBdOiBoYW5kbGVDaGFuZ2VQYWdlKCdwcmV2SnVtcCcpLFxyXG4gIFtGVU5DX05BTkUuUEFHRVJfTkVYVEpVTVBdOiBoYW5kbGVDaGFuZ2VQYWdlKCduZXh0SnVtcCcpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJ1bkV2ZW50IChrZXk6IHN0cmluZywgbWFwczogYW55LCBwcm9wOiBTS0VZX05BTkUsIHBhcmFtczogYW55LCBldm50OiBhbnkpIHtcclxuICBsZXQgc2tleUxpc3QgPSBtYXBzW2tleS50b0xvd2VyQ2FzZSgpXVxyXG4gIGlmIChza2V5TGlzdCkge1xyXG4gICAgcmV0dXJuIHNrZXlMaXN0LnNvbWUoKHNrZXk6IFNLZXkpID0+IHNrZXlbcHJvcF0ocGFyYW1zLCBldm50KSA9PT0gZmFsc2UpXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVTaG9ydGN1dEtleUV2ZW50IChwYXJhbXM6IGFueSwgZXZudDogYW55KSB7XHJcbiAgbGV0IGtleSA9IGdldEV2ZW50S2V5KGV2bnQua2V5KVxyXG4gIGlmICghcnVuRXZlbnQoa2V5LCBkaXNhYmxlZE1hcHMsIFNLRVlfTkFORS5FTUlULCBwYXJhbXMsIGV2bnQpKSB7XHJcbiAgICBydW5FdmVudChrZXksIHNldHRpbmdNYXBzLCBTS0VZX05BTkUuVFJJR0dFUiwgcGFyYW1zLCBldm50KVxyXG4gICAgcnVuRXZlbnQoa2V5LCBsaXN0ZW5lck1hcHMsIFNLRVlfTkFORS5FTUlULCBwYXJhbXMsIGV2bnQpXHJcbiAgfVxyXG59XHJcblxyXG5pbnRlcmZhY2UgcGFyc2VLZXlSZXN0IHtcclxuICByZWFsS2V5OiBzdHJpbmc7XHJcbiAgc3BlY2lhbEtleTogc3RyaW5nO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZUtleXMgKGtleTogc3RyaW5nKTogcGFyc2VLZXlSZXN0IHtcclxuICBsZXQgc3BlY2lhbEtleSA9ICcnXHJcbiAgbGV0IHJlYWxLZXkgPSAnJ1xyXG4gIGxldCBrZXlzID0ga2V5LnNwbGl0KCcrJylcclxuICBrZXlzLmZvckVhY2goKGl0ZW06IHN0cmluZykgPT4ge1xyXG4gICAgaXRlbSA9IGl0ZW0udG9Mb3dlckNhc2UoKS50cmltKClcclxuICAgIGlmIChzcGVjaWFsS2V5cy5pbmRleE9mKGl0ZW0pID4gLTEpIHtcclxuICAgICAgc3BlY2lhbEtleSA9IGl0ZW1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJlYWxLZXkgPSBpdGVtXHJcbiAgICB9XHJcbiAgfSlcclxuICBpZiAoIXJlYWxLZXkgfHwga2V5cy5sZW5ndGggPiAyIHx8IChrZXlzLmxlbmd0aCA9PT0gMiAmJiAhc3BlY2lhbEtleSkpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihgW3Z4ZS10YWJsZS1wbHVnaW4tc2hvcnRjdXQta2V5XSBJbnZhbGlkIHNob3J0Y3V0IGtleSBjb25maWd1cmF0aW9uICcke2tleX0nLmApXHJcbiAgfVxyXG4gIHJldHVybiB7IHJlYWxLZXksIHNwZWNpYWxLZXkgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBzZXRLZXlRdWV1ZSAobWFwczogS2V5U3RvcmVNYXBzLCBrQ29uZjogU2hvcnRjdXRLZXlDb25mLCBmdW5jTmFtZT86IEZVTkNfTkFORSkge1xyXG4gIGxldCB7IHJlYWxLZXksIHNwZWNpYWxLZXkgfSA9IHBhcnNlS2V5cyhrQ29uZi5rZXkpXHJcbiAgbGV0IHNrZXlMaXN0ID0gbWFwc1tyZWFsS2V5XVxyXG4gIGlmICghc2tleUxpc3QpIHtcclxuICAgIHNrZXlMaXN0ID0gbWFwc1tyZWFsS2V5XSA9IFtdXHJcbiAgfVxyXG4gIGlmIChza2V5TGlzdC5zb21lKChza2V5OiBTS2V5KSA9PiBza2V5LnJlYWxLZXkgPT09IHJlYWxLZXkgJiYgc2tleS5zcGVjaWFsS2V5ID09PSBzcGVjaWFsS2V5KSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKGBbdnhlLXRhYmxlLXBsdWdpbi1zaG9ydGN1dC1rZXldIFNob3J0Y3V0IGtleSBjb25mbGljdCAnJHtrQ29uZi5rZXl9Jy5gKVxyXG4gIH1cclxuICBza2V5TGlzdC5wdXNoKG5ldyBTS2V5KHJlYWxLZXksIHNwZWNpYWxLZXksIGZ1bmNOYW1lLCBrQ29uZikpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlRGlzYWJsZWRLZXkgKG9wdGlvbnM6IFNob3J0Y3V0S2V5T3B0aW9ucykge1xyXG4gIFhFVXRpbHMuZWFjaChvcHRpb25zLmRpc2FibGVkLCAoY29uZjogYW55KSA9PiB7XHJcbiAgICBsZXQgb3B0cyA9IFhFVXRpbHMuaXNTdHJpbmcoY29uZikgPyB7IGtleTogY29uZiB9IDogY29uZlxyXG4gICAgc2V0S2V5UXVldWUoZGlzYWJsZWRNYXBzLCBYRVV0aWxzLmFzc2lnbih7IGNhbGxiYWNrOiAoKSA9PiBmYWxzZSB9LCBvcHRzKSlcclxuICB9KVxyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZVNldHRpbmdLZXkgKG9wdGlvbnM6IFNob3J0Y3V0S2V5T3B0aW9ucykge1xyXG4gIFhFVXRpbHMuZWFjaChvcHRpb25zLnNldHRpbmcsIChvcHRzOiBhbnksIGZ1bmNOYW1lOiBGVU5DX05BTkUpID0+IHtcclxuICAgIGxldCBrQ29uZiA9IFhFVXRpbHMuaXNTdHJpbmcob3B0cykgPyB7IGtleTogb3B0cyB9IDogb3B0c1xyXG4gICAgaWYgKCFoYW5kbGVGdW5jc1tmdW5jTmFtZV0pIHtcclxuICAgICAgY29uc29sZS53YXJuKGBbdnhlLXRhYmxlLXBsdWdpbi1zaG9ydGN1dC1rZXldICcke2Z1bmNOYW1lfScgbm90IGV4aXN0LmApXHJcbiAgICB9XHJcbiAgICBzZXRLZXlRdWV1ZShzZXR0aW5nTWFwcywga0NvbmYsIGZ1bmNOYW1lKVxyXG4gIH0pXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlTGlzdGVuZXJLZXkgKG9wdGlvbnM6IFNob3J0Y3V0S2V5T3B0aW9ucykge1xyXG4gIFhFVXRpbHMuZWFjaChvcHRpb25zLmxpc3RlbmVyLCAoY2FsbGJhY2s6IEZ1bmN0aW9uLCBrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgaWYgKCFYRVV0aWxzLmlzRnVuY3Rpb24oY2FsbGJhY2spKSB7XHJcbiAgICAgIGNvbnNvbGUud2FybihgW3Z4ZS10YWJsZS1wbHVnaW4tc2hvcnRjdXQta2V5XSAnJHtrZXl9JyByZXF1aXJlcyB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gdG8gYmUgc2V0LmApXHJcbiAgICB9XHJcbiAgICBzZXRLZXlRdWV1ZShsaXN0ZW5lck1hcHMsIHsga2V5LCBjYWxsYmFjayB9KVxyXG4gIH0pXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU2hvcnRjdXRLZXlDb25mIHtcclxuICBrZXk6IHN0cmluZztcclxuICBjYWxsYmFjazogRnVuY3Rpb25cclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTaG9ydGN1dEtleU9wdGlvbnMge1xyXG4gIGRpc2FibGVkOiBzdHJpbmcgfCBTaG9ydGN1dEtleUNvbmZbXTtcclxuICBsaXN0ZW5lcjogb2JqZWN0O1xyXG4gIHNldHRpbmc6IG9iamVjdDtcclxufVxyXG5cclxuLyoqXHJcbiAqIOWfuuS6jiB2eGUtdGFibGUg6KGo5qC855qE5aKe5by65o+S5Lu277yM5Li66ZSu55uY5pON5L2c5o+Q5L6b5b+r5o236ZSu55qE6K6+572uXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgVlhFVGFibGVQbHVnaW5TaG9ydGN1dEtleSA9IHtcclxuICBpbnN0YWxsICh4dGFibGU6IHR5cGVvZiBWWEVUYWJsZSwgb3B0aW9ucz86IFNob3J0Y3V0S2V5T3B0aW9ucykge1xyXG4gICAgaWYgKG9wdGlvbnMpIHtcclxuICAgICAgcGFyc2VEaXNhYmxlZEtleShvcHRpb25zKVxyXG4gICAgICBwYXJzZVNldHRpbmdLZXkob3B0aW9ucylcclxuICAgICAgcGFyc2VMaXN0ZW5lcktleShvcHRpb25zKVxyXG4gICAgICB4dGFibGUuaW50ZXJjZXB0b3IuYWRkKCdldmVudC5rZXlkb3duJywgaGFuZGxlU2hvcnRjdXRLZXlFdmVudClcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuVlhFVGFibGUpIHtcclxuICB3aW5kb3cuVlhFVGFibGUudXNlKFZYRVRhYmxlUGx1Z2luU2hvcnRjdXRLZXkpXHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IFZYRVRhYmxlUGx1Z2luU2hvcnRjdXRLZXlcclxuIl19
