"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginShortcutKey = exports.handleFuncs = exports.SKey = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var _handleFuncs;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var arrowKeys = 'right,up,left,down'.split(',');
var specialKeys = 'alt,ctrl,shift,meta'.split(',');
var settingMaps = {};
var listenerMaps = {};
var disabledMaps = {};

var SKey = /*#__PURE__*/function () {
  function SKey(realKey, specialKey, funcName, kConf) {
    _classCallCheck(this, SKey);

    this.realKey = realKey;
    this.specialKey = specialKey;
    this.funcName = funcName;
    this.kConf = kConf;
  }

  _createClass(SKey, [{
    key: "trigger"
    /* TRIGGER */
    ,
    value: function trigger(params, evnt) {
      if (!this.specialKey || evnt["".concat(this.specialKey, "Key")]) {
        if (this.funcName) {
          return handleFuncs[this.funcName](params, evnt);
        }
      }
    }
  }, {
    key: "emit"
    /* EMIT */
    ,
    value: function emit(params, evnt) {
      if (!this.specialKey || evnt["".concat(this.specialKey, "Key")]) {
        if (this.kConf) {
          return this.kConf.callback(params, evnt);
        }
      }
    }
  }]);

  return SKey;
}();

exports.SKey = SKey;

function getEventKey(key) {
  if (arrowKeys.indexOf(key.toLowerCase()) > -1) {
    return "Arrow".concat(key);
  }

  return key;
}

function isTriggerPage(params) {
  return !params.$table.getActiveRecord();
}

function handleChangePage(func) {
  return function (params, evnt) {
    var $grid = params.$grid,
        $table = params.$table;
    var _$table$mouseConfig = $table.mouseConfig,
        mouseConfig = _$table$mouseConfig === void 0 ? {} : _$table$mouseConfig;

    if ($grid && mouseConfig.selected !== true && ['input', 'textarea'].indexOf(evnt.target.tagName.toLowerCase()) === -1 && isTriggerPage(params)) {
      var pager = $grid.$refs.pager;

      if (pager) {
        evnt.preventDefault();
        pager[func](evnt);
      }
    }
  };
}

function handleCellMove(arrowIndex) {
  return function (params, evnt) {
    var $table = params.$table;
    var selected = $table.getSelectedCell();
    var arrows = [0, 0, 0, 0];
    arrows[arrowIndex] = 1;

    if (selected) {
      $table.moveSelected(selected.row, arrows[0], arrows[1], arrows[2], arrows[3], evnt);
      return false;
    }
  };
}

function handleCurrentRowMove(isDown) {
  return function (params, evnt) {
    var $table = params.$table;

    if ($table.highlightCurrentRow) {
      var currentRow = $table.getCurrentRecord();

      if (currentRow) {
        $table.moveCurrentRow(!isDown, isDown, evnt);
        return false;
      }
    }
  };
}
/**
 * 快捷键处理方法
 */


var handleFuncs = (_handleFuncs = {}, _defineProperty(_handleFuncs, "table.edit.actived"
/* TABLE_EDIT_ACTIVED */
, function tableEditActived(params, evnt) {
  var $table = params.$table;
  var selected = $table.getSelectedCell();

  if (selected) {
    evnt.preventDefault();
    $table.setActiveCell(selected.row, selected.column.property);
    return false;
  }
}), _defineProperty(_handleFuncs, "table.edit.closed"
/* TABLE_EDIT_CLOSED */
, function tableEditClosed(params, evnt) {
  var $table = params.$table;
  var _$table$mouseConfig2 = $table.mouseConfig,
      mouseConfig = _$table$mouseConfig2 === void 0 ? {} : _$table$mouseConfig2;
  var actived = $table.getActiveRecord();

  if (actived) {
    evnt.preventDefault();
    $table.clearActived();

    if (mouseConfig.selected) {
      $table.$nextTick(function () {
        return $table.setSelectCell(actived.row, actived.column.property);
      });
    }

    return false;
  }
}), _defineProperty(_handleFuncs, "table.cell.leftMove"
/* TABLE_CELL_LEFTMOVE */
, handleCellMove(0)), _defineProperty(_handleFuncs, "table.cell.upMove"
/* TABLE_CELL_UPMOVE */
, handleCellMove(1)), _defineProperty(_handleFuncs, "table.cell.rightMove"
/* TABLE_CELL_RIGHTMOVE */
, handleCellMove(2)), _defineProperty(_handleFuncs, "table.cell.downMove"
/* TABLE_CELL_DOWNMOVE */
, handleCellMove(3)), _defineProperty(_handleFuncs, "table.row.current.topMove"
/* TABLE_ROW_CURRENT_TOPMOVE */
, handleCurrentRowMove(false)), _defineProperty(_handleFuncs, "table.row.current.downMove"
/* TABLE_ROW_CURRENT_DOWNMOVE */
, handleCurrentRowMove(true)), _defineProperty(_handleFuncs, "pager.prevPage"
/* PAGER_PREVPAGE */
, handleChangePage('prevPage')), _defineProperty(_handleFuncs, "pager.nextPage"
/* PAGER_NEXTPAGE */
, handleChangePage('nextPage')), _defineProperty(_handleFuncs, "pager.prevJump"
/* PAGER_PREVJUMP */
, handleChangePage('prevJump')), _defineProperty(_handleFuncs, "pager.nextJump"
/* PAGER_NEXTJUMP */
, handleChangePage('nextJump')), _handleFuncs);
exports.handleFuncs = handleFuncs;

function runEvent(key, maps, prop, params, evnt) {
  var skeyList = maps[key.toLowerCase()];

  if (skeyList) {
    return !skeyList.some(function (skey) {
      return skey[prop](params, evnt) === false;
    });
  }
}

function handleShortcutKeyEvent(params, evnt) {
  var key = getEventKey(evnt.key);

  if (!runEvent(key, disabledMaps, "emit"
  /* EMIT */
  , params, evnt)) {
    if (runEvent(key, settingMaps, "trigger"
    /* TRIGGER */
    , params, evnt) === false) {
      return false;
    }

    runEvent(key, listenerMaps, "emit"
    /* EMIT */
    , params, evnt);
  }
}

function parseKeys(key) {
  var specialKey = '';
  var realKey = '';
  var keys = key.split('+');
  keys.forEach(function (item) {
    item = item.toLowerCase().trim();

    if (specialKeys.indexOf(item) > -1) {
      specialKey = item;
    } else {
      realKey = item;
    }
  });

  if (!realKey || keys.length > 2 || keys.length === 2 && !specialKey) {
    throw new Error("[vxe-table-plugin-shortcut-key] Invalid shortcut key configuration '".concat(key, "'."));
  }

  return {
    realKey: realKey,
    specialKey: specialKey
  };
}

function setKeyQueue(maps, kConf, funcName) {
  var _parseKeys = parseKeys(kConf.key),
      realKey = _parseKeys.realKey,
      specialKey = _parseKeys.specialKey;

  var skeyList = maps[realKey];

  if (!skeyList) {
    skeyList = maps[realKey] = [];
  }

  if (skeyList.some(function (skey) {
    return skey.realKey === realKey && skey.specialKey === specialKey;
  })) {
    throw new Error("[vxe-table-plugin-shortcut-key] Shortcut key conflict '".concat(kConf.key, "'."));
  }

  skeyList.push(new SKey(realKey, specialKey, funcName, kConf));
}

function parseDisabledKey(options) {
  _xeUtils["default"].each(options.disabled, function (conf) {
    var opts = _xeUtils["default"].isString(conf) ? {
      key: conf
    } : conf;
    setKeyQueue(disabledMaps, _xeUtils["default"].assign({
      callback: function callback() {
        return false;
      }
    }, opts));
  });
}

function parseSettingKey(options) {
  _xeUtils["default"].each(options.setting, function (opts, funcName) {
    var kConf = _xeUtils["default"].isString(opts) ? {
      key: opts
    } : opts;

    if (!handleFuncs[funcName]) {
      console.warn("[vxe-table-plugin-shortcut-key] '".concat(funcName, "' not exist."));
    }

    setKeyQueue(settingMaps, kConf, funcName);
  });
}

function parseListenerKey(options) {
  _xeUtils["default"].each(options.listener, function (callback, key) {
    if (!_xeUtils["default"].isFunction(callback)) {
      console.warn("[vxe-table-plugin-shortcut-key] '".concat(key, "' requires the callback function to be set."));
    }

    setKeyQueue(listenerMaps, {
      key: key,
      callback: callback
    });
  });
}
/**
 * 设置参数
 * @param options 参数
 */


function setup(options) {
  if (options) {
    parseDisabledKey(options);
    parseSettingKey(options);
    parseListenerKey(options);
  }
}
/**
 * 基于 vxe-table 表格的增强插件，为键盘操作提供快捷键的设置
 */


var VXETablePluginShortcutKey = {
  setup: setup,
  install: function install(xtable, options) {
    if (options) {
      setup(options);
    }

    xtable.interceptor.add('event.keydown', handleShortcutKeyEvent);
  }
};
exports.VXETablePluginShortcutKey = VXETablePluginShortcutKey;

if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginShortcutKey);
}

var _default = VXETablePluginShortcutKey;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImFycm93S2V5cyIsInNwbGl0Iiwic3BlY2lhbEtleXMiLCJzZXR0aW5nTWFwcyIsImxpc3RlbmVyTWFwcyIsImRpc2FibGVkTWFwcyIsIlNLZXkiLCJyZWFsS2V5Iiwic3BlY2lhbEtleSIsImZ1bmNOYW1lIiwia0NvbmYiLCJwYXJhbXMiLCJldm50IiwiaGFuZGxlRnVuY3MiLCJjYWxsYmFjayIsImdldEV2ZW50S2V5Iiwia2V5IiwiaW5kZXhPZiIsInRvTG93ZXJDYXNlIiwiaXNUcmlnZ2VyUGFnZSIsIiR0YWJsZSIsImdldEFjdGl2ZVJlY29yZCIsImhhbmRsZUNoYW5nZVBhZ2UiLCJmdW5jIiwiJGdyaWQiLCJtb3VzZUNvbmZpZyIsInNlbGVjdGVkIiwidGFyZ2V0IiwidGFnTmFtZSIsInBhZ2VyIiwiJHJlZnMiLCJwcmV2ZW50RGVmYXVsdCIsImhhbmRsZUNlbGxNb3ZlIiwiYXJyb3dJbmRleCIsImdldFNlbGVjdGVkQ2VsbCIsImFycm93cyIsIm1vdmVTZWxlY3RlZCIsInJvdyIsImhhbmRsZUN1cnJlbnRSb3dNb3ZlIiwiaXNEb3duIiwiaGlnaGxpZ2h0Q3VycmVudFJvdyIsImN1cnJlbnRSb3ciLCJnZXRDdXJyZW50UmVjb3JkIiwibW92ZUN1cnJlbnRSb3ciLCJzZXRBY3RpdmVDZWxsIiwiY29sdW1uIiwicHJvcGVydHkiLCJhY3RpdmVkIiwiY2xlYXJBY3RpdmVkIiwiJG5leHRUaWNrIiwic2V0U2VsZWN0Q2VsbCIsInJ1bkV2ZW50IiwibWFwcyIsInByb3AiLCJza2V5TGlzdCIsInNvbWUiLCJza2V5IiwiaGFuZGxlU2hvcnRjdXRLZXlFdmVudCIsInBhcnNlS2V5cyIsImtleXMiLCJmb3JFYWNoIiwiaXRlbSIsInRyaW0iLCJsZW5ndGgiLCJFcnJvciIsInNldEtleVF1ZXVlIiwicHVzaCIsInBhcnNlRGlzYWJsZWRLZXkiLCJvcHRpb25zIiwiWEVVdGlscyIsImVhY2giLCJkaXNhYmxlZCIsImNvbmYiLCJvcHRzIiwiaXNTdHJpbmciLCJhc3NpZ24iLCJwYXJzZVNldHRpbmdLZXkiLCJzZXR0aW5nIiwiY29uc29sZSIsIndhcm4iLCJwYXJzZUxpc3RlbmVyS2V5IiwibGlzdGVuZXIiLCJpc0Z1bmN0aW9uIiwic2V0dXAiLCJWWEVUYWJsZVBsdWdpblNob3J0Y3V0S2V5IiwiaW5zdGFsbCIsInh0YWJsZSIsImludGVyY2VwdG9yIiwiYWRkIiwid2luZG93IiwiVlhFVGFibGUiLCJ1c2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7QUE0QkEsSUFBTUEsU0FBUyxHQUFHLHFCQUFxQkMsS0FBckIsQ0FBMkIsR0FBM0IsQ0FBbEI7QUFDQSxJQUFNQyxXQUFXLEdBQUcsc0JBQXNCRCxLQUF0QixDQUE0QixHQUE1QixDQUFwQjtBQUNBLElBQU1FLFdBQVcsR0FBaUIsRUFBbEM7QUFDQSxJQUFNQyxZQUFZLEdBQWlCLEVBQW5DO0FBQ0EsSUFBTUMsWUFBWSxHQUFpQixFQUFuQzs7SUFFYUMsSTtBQUtYLGdCQUFhQyxPQUFiLEVBQThCQyxVQUE5QixFQUFrREMsUUFBbEQsRUFBd0VDLEtBQXhFLEVBQStGO0FBQUE7O0FBQzdGLFNBQUtILE9BQUwsR0FBZUEsT0FBZjtBQUNBLFNBQUtDLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQkEsUUFBaEI7QUFDQSxTQUFLQyxLQUFMLEdBQWFBLEtBQWI7QUFDRDs7O1NBQ0Q7QUFBQTs7NEJBQXFCQyxNLEVBQWtDQyxJLEVBQVM7QUFDOUQsVUFBSSxDQUFDLEtBQUtKLFVBQU4sSUFBb0JJLElBQUksV0FBSSxLQUFLSixVQUFULFNBQTVCLEVBQXVEO0FBQ3JELFlBQUksS0FBS0MsUUFBVCxFQUFtQjtBQUNqQixpQkFBT0ksV0FBVyxDQUFDLEtBQUtKLFFBQU4sQ0FBWCxDQUEyQkUsTUFBM0IsRUFBbUNDLElBQW5DLENBQVA7QUFDRDtBQUNGO0FBQ0Y7O1NBQ0Q7QUFBQTs7eUJBQWtCRCxNLEVBQWtDQyxJLEVBQVM7QUFDM0Qs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QUEsUUFBUSxFQUFSQTtBQUFQLEtBQWYsQ0FBWDtBQUNELEdBTEQ7QUFNRDtBQXFCRDs7Ozs7O0FBSUEsU0FBU3FFLEtBQVQsQ0FBZ0JmLE9BQWhCLEVBQTJDO0FBQ3pDLE1BQUlBLE9BQUosRUFBYTtBQUNYRCxJQUFBQSxnQkFBZ0IsQ0FBQ0MsT0FBRCxDQUFoQjtBQUNBUSxJQUFBQSxlQUFlLENBQUNSLE9BQUQsQ0FBZjtBQUNBWSxJQUFBQSxnQkFBZ0IsQ0FBQ1osT0FBRCxDQUFoQjtBQUNEO0FBQ0Y7QUFFRDs7Ozs7QUFHTyxJQUFNZ0IseUJBQXlCLEdBQUc7QUFDdkNELEVBQUFBLEtBQUssRUFBTEEsS0FEdUM7QUFFdkNFLEVBQUFBLE9BRnVDLG1CQUU5QkMsTUFGOEIsRUFFTGxCLE9BRkssRUFFdUI7QUFDNUQsUUFBSUEsT0FBSixFQUFhO0FBQ1hlLE1BQUFBLEtBQUssQ0FBQ2YsT0FBRCxDQUFMO0FBQ0Q7O0FBQ0RrQixJQUFBQSxNQUFNLENBQUNDLFdBQVAsQ0FBbUJDLEdBQW5CLENBQXVCLGVBQXZCLEVBQXdDL0Isc0JBQXhDO0FBQ0Q7QUFQc0MsQ0FBbEM7OztBQVVQLElBQUksT0FBT2dDLE1BQVAsS0FBa0IsV0FBbEIsSUFBaUNBLE1BQU0sQ0FBQ0MsUUFBNUMsRUFBc0Q7QUFDcERELEVBQUFBLE1BQU0sQ0FBQ0MsUUFBUCxDQUFnQkMsR0FBaEIsQ0FBb0JQLHlCQUFwQjtBQUNEOztlQUVjQSx5QiIsImZpbGUiOiJpbmRleC5jb21tb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby11bnVzZWQtdmFycyAqL1xyXG5pbXBvcnQgWEVVdGlscyBmcm9tICd4ZS11dGlscy9tZXRob2RzL3hlLXV0aWxzJ1xyXG5pbXBvcnQgeyBWWEVUYWJsZSwgSW50ZXJjZXB0b3JLZXlkb3duUGFyYW1zIH0gZnJvbSAndnhlLXRhYmxlL2xpYi92eGUtdGFibGUnXHJcblxyXG5leHBvcnQgY29uc3QgZW51bSBGVU5DX05BTkUge1xyXG4gIFRBQkxFX0VESVRfQUNUSVZFRCA9ICd0YWJsZS5lZGl0LmFjdGl2ZWQnLFxyXG4gIFRBQkxFX0VESVRfQ0xPU0VEID0gJ3RhYmxlLmVkaXQuY2xvc2VkJyxcclxuICBUQUJMRV9DRUxMX0xFRlRNT1ZFID0gJ3RhYmxlLmNlbGwubGVmdE1vdmUnLFxyXG4gIFRBQkxFX0NFTExfVVBNT1ZFID0gJ3RhYmxlLmNlbGwudXBNb3ZlJyxcclxuICBUQUJMRV9DRUxMX1JJR0hUTU9WRSA9ICd0YWJsZS5jZWxsLnJpZ2h0TW92ZScsXHJcbiAgVEFCTEVfQ0VMTF9ET1dOTU9WRSA9ICd0YWJsZS5jZWxsLmRvd25Nb3ZlJyxcclxuICBUQUJMRV9ST1dfQ1VSUkVOVF9UT1BNT1ZFID0gJ3RhYmxlLnJvdy5jdXJyZW50LnRvcE1vdmUnLFxyXG4gIFRBQkxFX1JPV19DVVJSRU5UX0RPV05NT1ZFID0gJ3RhYmxlLnJvdy5jdXJyZW50LmRvd25Nb3ZlJyxcclxuICBQQUdFUl9QUkVWUEFHRSA9ICdwYWdlci5wcmV2UGFnZScsXHJcbiAgUEFHRVJfTkVYVFBBR0UgPSAncGFnZXIubmV4dFBhZ2UnLFxyXG4gIFBBR0VSX1BSRVZKVU1QID0gJ3BhZ2VyLnByZXZKdW1wJyxcclxuICBQQUdFUl9ORVhUSlVNUCA9ICdwYWdlci5uZXh0SnVtcCdcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IGVudW0gU0tFWV9OQU5FIHtcclxuICBUUklHR0VSID0gJ3RyaWdnZXInLFxyXG4gIEVNSVQgPSAnZW1pdCdcclxufVxyXG4vKiBlc2xpbnQtZW5hYmxlIG5vLXVudXNlZC12YXJzICovXHJcblxyXG5pbnRlcmZhY2UgS2V5U3RvcmVNYXBzIHtcclxuICBbcHJvcE5hbWU6IHN0cmluZ106IFNLZXlbXTtcclxufVxyXG5cclxuY29uc3QgYXJyb3dLZXlzID0gJ3JpZ2h0LHVwLGxlZnQsZG93bicuc3BsaXQoJywnKVxyXG5jb25zdCBzcGVjaWFsS2V5cyA9ICdhbHQsY3RybCxzaGlmdCxtZXRhJy5zcGxpdCgnLCcpXHJcbmNvbnN0IHNldHRpbmdNYXBzOiBLZXlTdG9yZU1hcHMgPSB7fVxyXG5jb25zdCBsaXN0ZW5lck1hcHM6IEtleVN0b3JlTWFwcyA9IHt9XHJcbmNvbnN0IGRpc2FibGVkTWFwczogS2V5U3RvcmVNYXBzID0ge31cclxuXHJcbmV4cG9ydCBjbGFzcyBTS2V5IHtcclxuICByZWFsS2V5OiBzdHJpbmc7XHJcbiAgc3BlY2lhbEtleTogc3RyaW5nO1xyXG4gIGZ1bmNOYW1lPzogRlVOQ19OQU5FO1xyXG4gIGtDb25mPzogU2hvcnRjdXRLZXlDb25mO1xyXG4gIGNvbnN0cnVjdG9yIChyZWFsS2V5OiBzdHJpbmcsIHNwZWNpYWxLZXk6IHN0cmluZywgZnVuY05hbWU/OiBGVU5DX05BTkUsIGtDb25mPzogU2hvcnRjdXRLZXlDb25mKSB7XHJcbiAgICB0aGlzLnJlYWxLZXkgPSByZWFsS2V5XHJcbiAgICB0aGlzLnNwZWNpYWxLZXkgPSBzcGVjaWFsS2V5XHJcbiAgICB0aGlzLmZ1bmNOYW1lID0gZnVuY05hbWVcclxuICAgIHRoaXMua0NvbmYgPSBrQ29uZlxyXG4gIH1cclxuICBbU0tFWV9OQU5FLlRSSUdHRVJdIChwYXJhbXM6IEludGVyY2VwdG9yS2V5ZG93blBhcmFtcywgZXZudDogYW55KSB7XHJcbiAgICBpZiAoIXRoaXMuc3BlY2lhbEtleSB8fCBldm50W2Ake3RoaXMuc3BlY2lhbEtleX1LZXlgXSkge1xyXG4gICAgICBpZiAodGhpcy5mdW5jTmFtZSkge1xyXG4gICAgICAgIHJldHVybiBoYW5kbGVGdW5jc1t0aGlzLmZ1bmNOYW1lXShwYXJhbXMsIGV2bnQpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgW1NLRVlfTkFORS5FTUlUXSAocGFyYW1zOiBJbnRlcmNlcHRvcktleWRvd25QYXJhbXMsIGV2bnQ6IGFueSkge1xyXG4gICAgaWYgKCF0aGlzLnNwZWNpYWxLZXkgfHwgZXZudFtgJHt0aGlzLnNwZWNpYWxLZXl9S2V5YF0pIHtcclxuICAgICAgaWYgKHRoaXMua0NvbmYpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5rQ29uZi5jYWxsYmFjayhwYXJhbXMsIGV2bnQpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEV2ZW50S2V5IChrZXk6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgaWYgKGFycm93S2V5cy5pbmRleE9mKGtleS50b0xvd2VyQ2FzZSgpKSA+IC0xKSB7XHJcbiAgICByZXR1cm4gYEFycm93JHtrZXl9YFxyXG4gIH1cclxuICByZXR1cm4ga2V5XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzVHJpZ2dlclBhZ2UgKHBhcmFtczogSW50ZXJjZXB0b3JLZXlkb3duUGFyYW1zKTogYm9vbGVhbiB7XHJcbiAgcmV0dXJuICFwYXJhbXMuJHRhYmxlLmdldEFjdGl2ZVJlY29yZCgpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUNoYW5nZVBhZ2UgKGZ1bmM6IHN0cmluZykge1xyXG4gIHJldHVybiBmdW5jdGlvbiAocGFyYW1zOiBJbnRlcmNlcHRvcktleWRvd25QYXJhbXMsIGV2bnQ6IGFueSkge1xyXG4gICAgY29uc3QgeyAkZ3JpZCwgJHRhYmxlIH0gPSBwYXJhbXNcclxuICAgIGNvbnN0IHsgbW91c2VDb25maWcgPSB7fSB9ID0gJHRhYmxlXHJcbiAgICBpZiAoJGdyaWQgJiYgbW91c2VDb25maWcuc2VsZWN0ZWQgIT09IHRydWUgJiYgWydpbnB1dCcsICd0ZXh0YXJlYSddLmluZGV4T2YoZXZudC50YXJnZXQudGFnTmFtZS50b0xvd2VyQ2FzZSgpKSA9PT0gLTEgJiYgaXNUcmlnZ2VyUGFnZShwYXJhbXMpKSB7XHJcbiAgICAgIGNvbnN0IHBhZ2VyOiBhbnkgPSAkZ3JpZC4kcmVmcy5wYWdlclxyXG4gICAgICBpZiAocGFnZXIpIHtcclxuICAgICAgICBldm50LnByZXZlbnREZWZhdWx0KClcclxuICAgICAgICBwYWdlcltmdW5jXShldm50KVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVDZWxsTW92ZSAoYXJyb3dJbmRleDogbnVtYmVyKSB7XHJcbiAgcmV0dXJuIGZ1bmN0aW9uIChwYXJhbXM6IEludGVyY2VwdG9yS2V5ZG93blBhcmFtcywgZXZudDogYW55KSB7XHJcbiAgICBjb25zdCAkdGFibGU6IGFueSA9IHBhcmFtcy4kdGFibGVcclxuICAgIGNvbnN0IHNlbGVjdGVkID0gJHRhYmxlLmdldFNlbGVjdGVkQ2VsbCgpXHJcbiAgICBjb25zdCBhcnJvd3M6IG51bWJlcltdID0gWzAsIDAsIDAsIDBdXHJcbiAgICBhcnJvd3NbYXJyb3dJbmRleF0gPSAxXHJcbiAgICBpZiAoc2VsZWN0ZWQpIHtcclxuICAgICAgJHRhYmxlLm1vdmVTZWxlY3RlZChzZWxlY3RlZC5yb3csIGFycm93c1swXSwgYXJyb3dzWzFdLCBhcnJvd3NbMl0sIGFycm93c1szXSwgZXZudClcclxuICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVDdXJyZW50Um93TW92ZSAoaXNEb3duOiBib29sZWFuKSB7XHJcbiAgcmV0dXJuIGZ1bmN0aW9uIChwYXJhbXM6IEludGVyY2VwdG9yS2V5ZG93blBhcmFtcywgZXZudDogYW55KSB7XHJcbiAgICBjb25zdCAkdGFibGU6IGFueSA9IHBhcmFtcy4kdGFibGVcclxuICAgIGlmICgkdGFibGUuaGlnaGxpZ2h0Q3VycmVudFJvdykge1xyXG4gICAgICBjb25zdCBjdXJyZW50Um93ID0gJHRhYmxlLmdldEN1cnJlbnRSZWNvcmQoKVxyXG4gICAgICBpZiAoY3VycmVudFJvdykge1xyXG4gICAgICAgICR0YWJsZS5tb3ZlQ3VycmVudFJvdyghaXNEb3duLCBpc0Rvd24sIGV2bnQpXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDlv6vmjbfplK7lpITnkIbmlrnms5VcclxuICovXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVGdW5jcyA9IHtcclxuICBbRlVOQ19OQU5FLlRBQkxFX0VESVRfQUNUSVZFRF0gKHBhcmFtczogSW50ZXJjZXB0b3JLZXlkb3duUGFyYW1zLCBldm50OiBhbnkpIHtcclxuICAgIGNvbnN0IHsgJHRhYmxlIH0gPSBwYXJhbXNcclxuICAgIGNvbnN0IHNlbGVjdGVkID0gJHRhYmxlLmdldFNlbGVjdGVkQ2VsbCgpXHJcbiAgICBpZiAoc2VsZWN0ZWQpIHtcclxuICAgICAgZXZudC5wcmV2ZW50RGVmYXVsdCgpXHJcbiAgICAgICR0YWJsZS5zZXRBY3RpdmVDZWxsKHNlbGVjdGVkLnJvdywgc2VsZWN0ZWQuY29sdW1uLnByb3BlcnR5KVxyXG4gICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuICB9LFxyXG4gIFtGVU5DX05BTkUuVEFCTEVfRURJVF9DTE9TRURdIChwYXJhbXM6IEludGVyY2VwdG9yS2V5ZG93blBhcmFtcywgZXZudDogYW55KSB7XHJcbiAgICBjb25zdCB7ICR0YWJsZSB9ID0gcGFyYW1zXHJcbiAgICBjb25zdCB7IG1vdXNlQ29uZmlnID0ge30gfSA9ICR0YWJsZVxyXG4gICAgY29uc3QgYWN0aXZlZCA9ICR0YWJsZS5nZXRBY3RpdmVSZWNvcmQoKVxyXG4gICAgaWYgKGFjdGl2ZWQpIHtcclxuICAgICAgZXZudC5wcmV2ZW50RGVmYXVsdCgpXHJcbiAgICAgICR0YWJsZS5jbGVhckFjdGl2ZWQoKVxyXG4gICAgICBpZiAobW91c2VDb25maWcuc2VsZWN0ZWQpIHtcclxuICAgICAgICAkdGFibGUuJG5leHRUaWNrKCgpID0+ICR0YWJsZS5zZXRTZWxlY3RDZWxsKGFjdGl2ZWQucm93LCBhY3RpdmVkLmNvbHVtbi5wcm9wZXJ0eSkpXHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICB9XHJcbiAgfSxcclxuICBbRlVOQ19OQU5FLlRBQkxFX0NFTExfTEVGVE1PVkVdOiBoYW5kbGVDZWxsTW92ZSgwKSxcclxuICBbRlVOQ19OQU5FLlRBQkxFX0NFTExfVVBNT1ZFXTogaGFuZGxlQ2VsbE1vdmUoMSksXHJcbiAgW0ZVTkNfTkFORS5UQUJMRV9DRUxMX1JJR0hUTU9WRV06IGhhbmRsZUNlbGxNb3ZlKDIpLFxyXG4gIFtGVU5DX05BTkUuVEFCTEVfQ0VMTF9ET1dOTU9WRV06IGhhbmRsZUNlbGxNb3ZlKDMpLFxyXG4gIFtGVU5DX05BTkUuVEFCTEVfUk9XX0NVUlJFTlRfVE9QTU9WRV06IGhhbmRsZUN1cnJlbnRSb3dNb3ZlKGZhbHNlKSxcclxuICBbRlVOQ19OQU5FLlRBQkxFX1JPV19DVVJSRU5UX0RPV05NT1ZFXTogaGFuZGxlQ3VycmVudFJvd01vdmUodHJ1ZSksXHJcbiAgW0ZVTkNfTkFORS5QQUdFUl9QUkVWUEFHRV06IGhhbmRsZUNoYW5nZVBhZ2UoJ3ByZXZQYWdlJyksXHJcbiAgW0ZVTkNfTkFORS5QQUdFUl9ORVhUUEFHRV06IGhhbmRsZUNoYW5nZVBhZ2UoJ25leHRQYWdlJyksXHJcbiAgW0ZVTkNfTkFORS5QQUdFUl9QUkVWSlVNUF06IGhhbmRsZUNoYW5nZVBhZ2UoJ3ByZXZKdW1wJyksXHJcbiAgW0ZVTkNfTkFORS5QQUdFUl9ORVhUSlVNUF06IGhhbmRsZUNoYW5nZVBhZ2UoJ25leHRKdW1wJylcclxufVxyXG5cclxuZnVuY3Rpb24gcnVuRXZlbnQgKGtleTogc3RyaW5nLCBtYXBzOiBhbnksIHByb3A6IFNLRVlfTkFORSwgcGFyYW1zOiBJbnRlcmNlcHRvcktleWRvd25QYXJhbXMsIGV2bnQ6IGFueSkge1xyXG4gIGxldCBza2V5TGlzdDogU0tleVtdID0gbWFwc1trZXkudG9Mb3dlckNhc2UoKV1cclxuICBpZiAoc2tleUxpc3QpIHtcclxuICAgIHJldHVybiAhc2tleUxpc3Quc29tZSgoc2tleTogU0tleSkgPT4gc2tleVtwcm9wXShwYXJhbXMsIGV2bnQpID09PSBmYWxzZSlcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZVNob3J0Y3V0S2V5RXZlbnQgKHBhcmFtczogSW50ZXJjZXB0b3JLZXlkb3duUGFyYW1zLCBldm50OiBhbnkpIHtcclxuICBsZXQga2V5OiBzdHJpbmcgPSBnZXRFdmVudEtleShldm50LmtleSlcclxuICBpZiAoIXJ1bkV2ZW50KGtleSwgZGlzYWJsZWRNYXBzLCBTS0VZX05BTkUuRU1JVCwgcGFyYW1zLCBldm50KSkge1xyXG4gICAgaWYgKHJ1bkV2ZW50KGtleSwgc2V0dGluZ01hcHMsIFNLRVlfTkFORS5UUklHR0VSLCBwYXJhbXMsIGV2bnQpID09PSBmYWxzZSkge1xyXG4gICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuICAgIHJ1bkV2ZW50KGtleSwgbGlzdGVuZXJNYXBzLCBTS0VZX05BTkUuRU1JVCwgcGFyYW1zLCBldm50KVxyXG4gIH1cclxufVxyXG5cclxuaW50ZXJmYWNlIHBhcnNlS2V5UmVzdCB7XHJcbiAgcmVhbEtleTogc3RyaW5nO1xyXG4gIHNwZWNpYWxLZXk6IHN0cmluZztcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VLZXlzIChrZXk6IHN0cmluZyk6IHBhcnNlS2V5UmVzdCB7XHJcbiAgbGV0IHNwZWNpYWxLZXkgPSAnJ1xyXG4gIGxldCByZWFsS2V5ID0gJydcclxuICBsZXQga2V5cyA9IGtleS5zcGxpdCgnKycpXHJcbiAga2V5cy5mb3JFYWNoKChpdGVtKSA9PiB7XHJcbiAgICBpdGVtID0gaXRlbS50b0xvd2VyQ2FzZSgpLnRyaW0oKVxyXG4gICAgaWYgKHNwZWNpYWxLZXlzLmluZGV4T2YoaXRlbSkgPiAtMSkge1xyXG4gICAgICBzcGVjaWFsS2V5ID0gaXRlbVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVhbEtleSA9IGl0ZW1cclxuICAgIH1cclxuICB9KVxyXG4gIGlmICghcmVhbEtleSB8fCBrZXlzLmxlbmd0aCA+IDIgfHwgKGtleXMubGVuZ3RoID09PSAyICYmICFzcGVjaWFsS2V5KSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKGBbdnhlLXRhYmxlLXBsdWdpbi1zaG9ydGN1dC1rZXldIEludmFsaWQgc2hvcnRjdXQga2V5IGNvbmZpZ3VyYXRpb24gJyR7a2V5fScuYClcclxuICB9XHJcbiAgcmV0dXJuIHsgcmVhbEtleSwgc3BlY2lhbEtleSB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNldEtleVF1ZXVlIChtYXBzOiBLZXlTdG9yZU1hcHMsIGtDb25mOiBTaG9ydGN1dEtleUNvbmYsIGZ1bmNOYW1lPzogRlVOQ19OQU5FKSB7XHJcbiAgbGV0IHsgcmVhbEtleSwgc3BlY2lhbEtleSB9ID0gcGFyc2VLZXlzKGtDb25mLmtleSlcclxuICBsZXQgc2tleUxpc3Q6IFNLZXlbXSA9IG1hcHNbcmVhbEtleV1cclxuICBpZiAoIXNrZXlMaXN0KSB7XHJcbiAgICBza2V5TGlzdCA9IG1hcHNbcmVhbEtleV0gPSBbXVxyXG4gIH1cclxuICBpZiAoc2tleUxpc3Quc29tZSgoc2tleSkgPT4gc2tleS5yZWFsS2V5ID09PSByZWFsS2V5ICYmIHNrZXkuc3BlY2lhbEtleSA9PT0gc3BlY2lhbEtleSkpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihgW3Z4ZS10YWJsZS1wbHVnaW4tc2hvcnRjdXQta2V5XSBTaG9ydGN1dCBrZXkgY29uZmxpY3QgJyR7a0NvbmYua2V5fScuYClcclxuICB9XHJcbiAgc2tleUxpc3QucHVzaChuZXcgU0tleShyZWFsS2V5LCBzcGVjaWFsS2V5LCBmdW5jTmFtZSwga0NvbmYpKVxyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZURpc2FibGVkS2V5IChvcHRpb25zOiBTaG9ydGN1dEtleU9wdGlvbnMpIHtcclxuICBYRVV0aWxzLmVhY2gob3B0aW9ucy5kaXNhYmxlZCwgKGNvbmY6IHN0cmluZyB8IFNob3J0Y3V0S2V5Q29uZikgPT4ge1xyXG4gICAgbGV0IG9wdHM6IGFueSA9IFhFVXRpbHMuaXNTdHJpbmcoY29uZikgPyB7IGtleTogY29uZiB9IDogY29uZlxyXG4gICAgc2V0S2V5UXVldWUoZGlzYWJsZWRNYXBzLCBYRVV0aWxzLmFzc2lnbih7IGNhbGxiYWNrOiAoKSA9PiBmYWxzZSB9LCBvcHRzKSlcclxuICB9KVxyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZVNldHRpbmdLZXkgKG9wdGlvbnM6IFNob3J0Y3V0S2V5T3B0aW9ucykge1xyXG4gIFhFVXRpbHMuZWFjaChvcHRpb25zLnNldHRpbmcsIChvcHRzOiBzdHJpbmcgfCBTaG9ydGN1dEtleVNldHRpbmdDb25maWcsIGZ1bmNOYW1lOiBGVU5DX05BTkUpID0+IHtcclxuICAgIGxldCBrQ29uZjogYW55ID0gWEVVdGlscy5pc1N0cmluZyhvcHRzKSA/IHsga2V5OiBvcHRzIH0gOiBvcHRzXHJcbiAgICBpZiAoIWhhbmRsZUZ1bmNzW2Z1bmNOYW1lXSkge1xyXG4gICAgICBjb25zb2xlLndhcm4oYFt2eGUtdGFibGUtcGx1Z2luLXNob3J0Y3V0LWtleV0gJyR7ZnVuY05hbWV9JyBub3QgZXhpc3QuYClcclxuICAgIH1cclxuICAgIHNldEtleVF1ZXVlKHNldHRpbmdNYXBzLCBrQ29uZiwgZnVuY05hbWUpXHJcbiAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VMaXN0ZW5lcktleSAob3B0aW9uczogU2hvcnRjdXRLZXlPcHRpb25zKSB7XHJcbiAgWEVVdGlscy5lYWNoKG9wdGlvbnMubGlzdGVuZXIsIChjYWxsYmFjazogRnVuY3Rpb24sIGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICBpZiAoIVhFVXRpbHMuaXNGdW5jdGlvbihjYWxsYmFjaykpIHtcclxuICAgICAgY29uc29sZS53YXJuKGBbdnhlLXRhYmxlLXBsdWdpbi1zaG9ydGN1dC1rZXldICcke2tleX0nIHJlcXVpcmVzIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB0byBiZSBzZXQuYClcclxuICAgIH1cclxuICAgIHNldEtleVF1ZXVlKGxpc3RlbmVyTWFwcywgeyBrZXksIGNhbGxiYWNrIH0pXHJcbiAgfSlcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTaG9ydGN1dEtleUNvbmYge1xyXG4gIGtleTogc3RyaW5nO1xyXG4gIGNhbGxiYWNrOiBGdW5jdGlvblxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFNob3J0Y3V0S2V5TGlzdGVuZXJDb25maWcge1xyXG4gIFtmdW5jTmFtZTogc3RyaW5nXTogKHBhcmFtczogSW50ZXJjZXB0b3JLZXlkb3duUGFyYW1zLCBldm50OiBhbnkpID0+IGFueTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTaG9ydGN1dEtleVNldHRpbmdDb25maWcge1xyXG4gIFtmdW5jTmFtZTogc3RyaW5nXTogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFNob3J0Y3V0S2V5T3B0aW9ucyB7XHJcbiAgZGlzYWJsZWQ/OiBzdHJpbmdbXSB8IFNob3J0Y3V0S2V5Q29uZltdO1xyXG4gIGxpc3RlbmVyPzogU2hvcnRjdXRLZXlMaXN0ZW5lckNvbmZpZztcclxuICBzZXR0aW5nPzogU2hvcnRjdXRLZXlTZXR0aW5nQ29uZmlnO1xyXG59XHJcblxyXG4vKipcclxuICog6K6+572u5Y+C5pWwXHJcbiAqIEBwYXJhbSBvcHRpb25zIOWPguaVsFxyXG4gKi9cclxuZnVuY3Rpb24gc2V0dXAgKG9wdGlvbnM6IFNob3J0Y3V0S2V5T3B0aW9ucykge1xyXG4gIGlmIChvcHRpb25zKSB7XHJcbiAgICBwYXJzZURpc2FibGVkS2V5KG9wdGlvbnMpXHJcbiAgICBwYXJzZVNldHRpbmdLZXkob3B0aW9ucylcclxuICAgIHBhcnNlTGlzdGVuZXJLZXkob3B0aW9ucylcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDln7rkuo4gdnhlLXRhYmxlIOihqOagvOeahOWinuW8uuaPkuS7tu+8jOS4uumUruebmOaTjeS9nOaPkOS+m+W/q+aNt+mUrueahOiuvue9rlxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IFZYRVRhYmxlUGx1Z2luU2hvcnRjdXRLZXkgPSB7XHJcbiAgc2V0dXAsXHJcbiAgaW5zdGFsbCAoeHRhYmxlOiB0eXBlb2YgVlhFVGFibGUsIG9wdGlvbnM/OiBTaG9ydGN1dEtleU9wdGlvbnMpIHtcclxuICAgIGlmIChvcHRpb25zKSB7XHJcbiAgICAgIHNldHVwKG9wdGlvbnMpXHJcbiAgICB9XHJcbiAgICB4dGFibGUuaW50ZXJjZXB0b3IuYWRkKCdldmVudC5rZXlkb3duJywgaGFuZGxlU2hvcnRjdXRLZXlFdmVudClcclxuICB9XHJcbn1cclxuXHJcbmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuVlhFVGFibGUpIHtcclxuICB3aW5kb3cuVlhFVGFibGUudXNlKFZYRVRhYmxlUGx1Z2luU2hvcnRjdXRLZXkpXHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IFZYRVRhYmxlUGx1Z2luU2hvcnRjdXRLZXlcclxuIl19
